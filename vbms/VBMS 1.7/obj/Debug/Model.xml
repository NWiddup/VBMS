<?xml version="1.0" encoding="utf-8"?>
<DataSchemaModel FileFormatVersion="1.2" SchemaVersion="2.9" DspName="Microsoft.Data.Tools.Schema.Sql.Sql140DatabaseSchemaProvider" CollationLcid="1033" CollationCaseSensitive="True" xmlns="http://schemas.microsoft.com/sqlserver/dac/Serialization/2012/02">
	<Header>
		<CustomData Category="AnsiNulls">
			<Metadata Name="AnsiNulls" Value="True" />
		</CustomData>
		<CustomData Category="QuotedIdentifier">
			<Metadata Name="QuotedIdentifier" Value="True" />
		</CustomData>
		<CustomData Category="CompatibilityMode">
			<Metadata Name="CompatibilityMode" Value="140" />
		</CustomData>
		<CustomData Category="Reference" Type="SqlSchema">
			<Metadata Name="FileName" Value="C:\PROGRAM FILES (X86)\MICROSOFT VISUAL STUDIO\2017\ENTERPRISE\COMMON7\IDE\EXTENSIONS\MICROSOFT\SQLDB\EXTENSIONS\SQLSERVER\100\SQLSCHEMAS\MASTER.DACPAC" />
			<Metadata Name="LogicalName" Value="master.dacpac" />
			<Metadata Name="ExternalParts" Value="[master]" />
			<Metadata Name="SuppressMissingDependenciesErrors" Value="False" />
		</CustomData>
		<CustomData Category="Reference" Type="SqlSchema">
			<Metadata Name="FileName" Value="C:\PROGRAM FILES (X86)\MICROSOFT VISUAL STUDIO\2017\ENTERPRISE\COMMON7\IDE\EXTENSIONS\MICROSOFT\SQLDB\EXTENSIONS\SQLSERVER\100\SQLSCHEMAS\MSDB.DACPAC" />
			<Metadata Name="LogicalName" Value="msdb.dacpac" />
			<Metadata Name="ExternalParts" Value="[msdb]" />
			<Metadata Name="SuppressMissingDependenciesErrors" Value="False" />
		</CustomData>
		<CustomData Category="Reference" Type="Assembly">
			<Metadata Name="LogicalName" Value="VBMS.dll" />
			<Metadata Name="FileName" Value="C:\USERS\OTRUTNEV\DOCUMENTS\VISUAL STUDIO 2015\PROJECTS\VBMS\VBMS 1.7\OBJ\DEBUG\VBMS.DLL" />
			<Metadata Name="AssemblyName" Value="VBMS" />
			<Metadata Name="PermissionSet" Value="SAFE" />
			<Metadata Name="Owner" Value="" />
			<Metadata Name="GenerateSqlClrDdl" Value="True" />
			<Metadata Name="IsVisible" Value="True" />
			<Metadata Name="IsModelAware" Value="True" />
			<Metadata Name="SkipCreationIfEmpty" Value="True" />
			<Metadata Name="AssemblySymbolsName" Value="C:\Users\otrutnev\Documents\Visual Studio 2015\Projects\vbms\VBMS 1.7\obj\Debug\VBMS.pdb" />
		</CustomData>
		<CustomData Category="SqlCmdVariables" Type="SqlCmdVariable" />
	</Header>
	<Model>
		<Element Type="SqlDatabaseOptions">
			<Property Name="Collation" Value="SQL_Latin1_General_CP1_CS_AS" />
			<Property Name="IsAnsiNullDefaultOn" Value="True" />
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Property Name="IsAnsiWarningsOn" Value="True" />
			<Property Name="IsArithAbortOn" Value="True" />
			<Property Name="IsConcatNullYieldsNullOn" Value="True" />
			<Property Name="IsTornPageProtectionOn" Value="False" />
			<Property Name="RecoveryMode" Value="1" />
			<Property Name="DefaultLanguage" Value="" />
			<Property Name="DefaultFullTextLanguage" Value="" />
			<Property Name="QueryStoreStaleQueryThreshold" Value="367" />
			<Relationship Name="DefaultFilegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(getdate())]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DBCCChecksLog]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[log_date]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="12" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[getdate()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Blacklist].[date_added]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="13" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Blacklist].[enabled]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="14" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA['John Doe']]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[owner]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="15" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA['Owner did not add any comment']]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[comment]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="16" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[use_user_db]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="17" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[0]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[use_system_db]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="18" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA['']]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[dbname_list]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="19" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[0]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[except_list]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="20" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[indexes]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="21" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[stats]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="22" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA['FULLSCAN']]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[stats_sample]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="23" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[checkall]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="24" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[checktable]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="25" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[checkalloc]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="26" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[checkcatalog]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="27" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[online_only]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="28" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[check_backup_state]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="29" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[check_ag_state]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="30" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[20000000]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[ag_max_queue]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="31" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[afterparty]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="32" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[1]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[add_stats_runtime]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="33" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[0]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[latched_spid]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="34" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[0]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[stoplight]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="35" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[getdate()]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[WorkerSessions].[record_date]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="36" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[0]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[WorkerSessions].[is_afterparty]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="37" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DBCCChecksLog].[rec_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DBCCChecksLog]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="38" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Blacklist].[item_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="39" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DbVersion].[Id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DbVersion]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="40" />
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[AddBlacklistItem]">
			<Property Name="BodyScript">
				<Value><![CDATA[

IF @entryid is not null 
BEGIN 

	IF @database_id is not null or @table_id is not null or @index_id is not null or @partition_n is not null or @subsystem_id is not null or @action_type_id is not null
	BEGIN
		RAISERROR('Parameter @entryid is incompatible with other parameters!',16,1)
		RETURN
	END

	SELECT 
		@database_id=[database_id],
		@table_id = table_id,
		@index_id = index_id,
		@partition_n = partition_n,
		@subsystem_id = CASE WHEN @subsystem_id is null THEN subsystem_id ELSE @subsystem_id END,
		@action_type_id = CASE WHEN @action_type_id is null THEN action_type_id ELSE @action_type_id END
	FROM dbo.Tasks
	WHERE entry_id = @entryid

	IF @subsystem_id <> 1 
		SET @partition_n = NULL
		
END
ELSE
BEGIN
	IF @database_id is null
	BEGIN
		RAISERROR('database_id not defined!',16,1)
		RETURN
	END

	IF @subsystem_id is null and @database_id is null
	BEGIN
		RAISERROR('subsystem_id not defined while DB Id is also not defined.',16,1)
		RETURN
	END

	IF @table_id is null and @subsystem_id <> 3 and @action_type_id not in (1,2)
	BEGIN
		RAISERROR('table_id not defined! P.s. You can not blacklist the whole DB this way.',16,1)
		RETURN
	END
END	
	INSERT INTO dbo.Blacklist 
	(
		[database_id], 
		[table_id], 
		[index_id], 
		[partition_n], 
		[subsystem_id], 
		[action_type_id],
		[enabled],
		[worker_name]
	)
	VALUES
	( 
		@database_id,
		@table_id,
		@index_id,
		@partition_n,
		@subsystem_id, 
		@action_type_id,
		1
		,@worker_name
	)]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[AddBlacklistItem].[@entryid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[AddBlacklistItem].[@database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[AddBlacklistItem].[@table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[AddBlacklistItem].[@index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[AddBlacklistItem].[@partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[AddBlacklistItem].[@subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[AddBlacklistItem].[@action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[enabled]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[AddBlacklistItem].[@worker_name]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[AddBlacklistItem].[@entryid]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[AddBlacklistItem].[@database_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[AddBlacklistItem].[@table_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[AddBlacklistItem].[@index_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[AddBlacklistItem].[@partition_n]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[AddBlacklistItem].[@subsystem_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[AddBlacklistItem].[@action_type_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[AddBlacklistItem].[@worker_name]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1810" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [dbo].[AddBlacklistItem]&#xD;&#xA;&#x9;@entryid bigint = NULL,&#xD;&#xA;&#x9;@database_id INT = NULL , &#xD;&#xA;    @table_id INT = NULL, &#xD;&#xA;    @index_id INT = NULL, &#xD;&#xA;    @partition_n INT = NULL, &#xD;&#xA;    @subsystem_id INT = NULL, &#xD;&#xA;    @action_type_id INT = NULL,&#xD;&#xA;&#x9;@worker_name nvarchar(255) NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlUniqueConstraint" Name="[dbo].[AK_WorkerSession_worker_name]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[WorkerSessions].[worker_name]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="41" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Blacklist]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[item_id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="39" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[date_added]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="13" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[database_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[table_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[index_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[partition_n]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[subsystem_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[action_type_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[enabled]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="14" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Blacklist].[worker_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[CheckLogSpaceLeft]">
			<Property Name="BodyScript">
				<Value><![CDATA[
DECLARE @sql nvarchar(max)
IF EXISTS (select 1 from sys.objects where name like '#result' and type = 'U')
DROP TABLE #result

CREATE TABLE #result  (
	dbname nvarchar(255),
	[mb_free] int
)

--We need dynamic t-sql to use FILEPROPERY function.
IF (@@MicrosoftVersion/0x01000000)<11
	BEGIN
	SET @sql='
USE [' + cast(db_name(@db) AS NVARCHAR(50)) + '];
DECLARE @Drives TABLE
(
	[drive] nvarchar(255),
	[free] bigint
)

INSERT INTO @Drives 
EXEC(''xp_fixeddrives'')

INSERT #result
SELECT
	DB_NAME(ms.database_id) as database_name,
	SUM(size/128.0 - CAST(FILEPROPERTY(name, ''SPACEUSED'') AS INT)/128.0 + CASE WHEN ms.max_size = -1 THEN d.free ELSE (max_size -size)/128.0 END) AS FREESPACEMB 
FROM 
	sys.master_files ms
	JOIN @Drives d on SUBSTRING(ms.physical_name,1,1) collate SQL_Latin1_General_CP1_CI_AS = d.drive collate SQL_Latin1_General_CP1_CI_AS
WHERE 
	database_id = DB_ID()
	and type = 1
GROUP BY 
	database_id
HAVING 
	SUM(size/128.0 - CAST(FILEPROPERTY(name, ''SPACEUSED'') AS INT)/128.0 + CASE WHEN ms.max_size = -1 THEN d.free ELSE (max_size -size)/128.0 END) < '+CAST(@limit_mb as nvarchar(50))
 END
 ELSE
 BEGIN
 set @sql = '
 USE [' + cast(db_name(@db) AS NVARCHAR(50)) + '];
 
INSERT #result
SELECT
	DB_NAME(ms.database_id) as database_name,
	SUM(size/128.0 - CAST(FILEPROPERTY(name, ''SPACEUSED'') AS INT)/128.0 + CASE WHEN ms.max_size = -1 THEN (vs.available_bytes)/1024/1024 ELSE (max_size -size)/128.0 END) AS FREESPACEMB 
FROM 
	sys.master_files ms
	CROSS APPLY sys.dm_os_volume_stats(ms.database_id, ms.file_id) vs
WHERE 
	ms.database_id = DB_ID()
	and type = 1
GROUP BY 
	ms.database_id
HAVING 
	SUM(size/128.0 - CAST(FILEPROPERTY(name, ''SPACEUSED'') AS INT)/128.0 + CASE WHEN ms.max_size = -1 THEN (vs.available_bytes)/1024/1024 ELSE (max_size -size)/128.0 END) < '+CAST(@limit_mb as nvarchar(50))
 
 END

EXEC(@sql)

IF @@rowcount >0
	BEGIN
	DROP TABLE #result
	RETURN 0
	END
ELSE 
	BEGIN
	DROP TABLE #result
	RETURN 1
	END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[objects]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[objects].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[objects].[type]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CheckLogSpaceLeft].[#result]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CheckLogSpaceLeft].[@db]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CheckLogSpaceLeft].[@limit_mb]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[CheckLogSpaceLeft].[#result]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[CheckLogSpaceLeft].[#result].[dbname]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="255" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[CheckLogSpaceLeft].[#result].[mb_free]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CheckLogSpaceLeft].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CheckLogSpaceLeft].[@limit_mb]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="642" />
				<Property Name="Length" Value="2792" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#x9;&#x9;Arseny Birukov arsbir@microsoft.com&#xD;&#xA;&#xD;&#xA;Процедура оценивает объем свободного места, доступный для журнала транзакций&#xD;&#xA;ВАЖНО: при использовании маунт пойнтов процедура ведет себя некорректно.&#xD;&#xA;&#xD;&#xA;The procedure estimates the free space available for the transaction log&#xD;&#xA;IMPORTANT: the result is wrong when mount points are used.&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[CheckLogSpaceLeft] &#xD;&#xA;(&#xD;&#xA;&#x9;@db int, &#xD;&#xA;&#x9;@limit_mb bigint&#xD;&#xA;)&#xD;&#xA;--DECLARE @db int = 6,@limit_mb int = 5000&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlCheckConstraint" Name="[dbo].[CK_Workers_Time]">
			<Property Name="CheckExpressionScript">
				<Value><![CDATA[ISNULL(indextime,0)+ISNULL(stattime,0)+ISNULL(checktime,0) <= 100]]></Value>
			</Property>
			<Relationship Name="CheckExpressionDependencies">
				<Entry>
					<References Name="[dbo].[Workers].[indextime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stattime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checktime]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="42" />
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[CloneWorkers]">
			<Property Name="BodyScript">
				<Value><![CDATA[
SET NOCOUNT ON
DECLARE @i int 
 
SET @i = @already_have+1

WHILE @i <= @already_have+@workers_num
	BEGIN
	BEGIN TRY
	INSERT INTO [dbo].[Workers]
           ([worker_name]
           ,[date_added]
           ,[owner]
           ,[comment]
           ,[use_user_db]
           ,[use_system_db]
           ,[dbname_list]
           ,[except_list]
           ,[indexes]
           ,[stats]
           ,[stats_sample]
           ,[checkall]
           ,[checktable]
           ,[checkalloc]
           ,[checkcatalog]
           ,[online_only]
           ,[afterparty]
           ,[add_stats_runtime]
           ,[totaltimemin]
           ,[indextime]
           ,[stattime]
           ,[checktime]
           )
     SELECT 
			@worker_name+@name_postfix+CAST(@i as nvarchar(5))
	       ,[date_added]
           ,[owner]
           ,[comment]
           ,[use_user_db]
           ,[use_system_db]
           ,[dbname_list]
           ,[except_list]
           ,[indexes]
           ,[stats]
           ,[stats_sample]
           ,[checkall]
           ,[checktable]
           ,[checkalloc]
           ,[checkcatalog]
           ,[online_only]
           ,[afterparty]
           ,0 --in parallel mode it is not recommended to use add_stats_runtime in several threads or duplicate tasks can be generated.
           ,[totaltimemin]
           ,[indextime]
           ,[stattime]
           ,[checktime]
	FROM dbo.Workers
	WHERE worker_name = @worker_name
	END TRY
	BEGIN CATCH
		THROW 51000,'Error during worker creation. Please check if it is already registered. If you need to add more workers please use starting_num parameter to set the starting position in naming to avoid duplicates.',1
	END CATCH
	SET @i = @i+1
	END
PRINT 'Workers have been created! Please note, that add_stats_runtime has been set to 0 for the added workers! Only one worker in the pack can have it set to 1 to avoid duplicate stats tasks creation during the execution.']]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CloneWorkers].[@already_have]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CloneWorkers].[@workers_num]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[owner]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[comment]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[use_user_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[use_system_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[dbname_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[except_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[indexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stats]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stats_sample]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkall]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checktable]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkalloc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkcatalog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[online_only]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[afterparty]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[add_stats_runtime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[totaltimemin]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[indextime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stattime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checktime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CloneWorkers].[@worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CloneWorkers].[@name_postfix]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CloneWorkers].[@worker_name]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CloneWorkers].[@workers_num]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CloneWorkers].[@already_have]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CloneWorkers].[@name_postfix]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA['_']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="20" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="195" />
				<Property Name="Length" Value="2560" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;Procedure to add more workers by cloning existing one.&#xD;&#xA;&#xD;&#xA;--dbo.CloneWorkers 'AW',2 --add two workers to AW&#xD;&#xA;--dbo.CloneWorkers @worker_name= 'AW',@workers_num = 6, @already_have =2&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE dbo.CloneWorkers (&#xD;&#xA;@worker_name nvarchar(255) --worker to use as a template,&#xD;&#xA;,@workers_num int --number of workers to add&#xD;&#xA;,@already_have int = 1 --numbers of workers, that we already got. Used to avoid PK violation.,&#xD;&#xA;,@name_postfix nvarchar(20) = '_' --postfix to use between the worker name and it's number. Ex: worker_1, worker_2&#xD;&#xA;)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[CollectIndexData]">
			<Property Name="BodyScript">
				<Value><![CDATA[
SET NOCOUNT ON
DECLARE
	@SQL nvarchar(max),
	@index_minsize bigint,
	@locktimeout bigint

	IF @batch is null
		SET @batch = NEWID()

--Удаляем устаревшие невыполненные задания / Old tasks cleanup
DELETE FROM dbo.FragmentationData
	WHERE database_id = @db
	AND analysis_started is null
	
	

--Считываем параметры / Loading parameters

SELECT @index_minsize = int_value
FROM dbo.Parameters
WHERE parameter = 'IndexMinimumSizeMB'

SELECT @locktimeout = int_value
FROM dbo.Parameters
WHERE parameter = 'LockTimeoutMs'



--Get list of all partitions and some stats on them
--This statement should be executed in different database context, so we have to use dynamic T-SQL
--The statement itself is static, it's relatively easy to unquote it
SET @SQL = 
'USE '+QUOTENAME(DB_NAME(@db))+';

DECLARE @worker_name nvarchar(255)
SELECT @worker_name = worker_name
FROM VBMS.dbo.WorkerSessions
WHERE session_id = @@SPID

SET LOCK_TIMEOUT '+CAST(@locktimeout as nvarchar(10))+';

INSERT INTO VBMS.[dbo].[FragmentationData]
           ([batch_id]
           ,[collection_date]
           ,[database_id]
           ,[schema_id]
           ,[object_id]
           ,[object_name]
           ,[index_id]
           ,[index_name]
           ,[allow_page_locks]
           ,[legacy_col_count]
           ,[xml_col_count]
           ,[user_scans]
           ,[partition_count]
           ,[partition_number]
           ,[row_count]
           ,[size_mb]
           ,[avg_fragmentation_in_percent]
		   ,[analysis_status]
		   ,[volume_mount_point])
     
SELECT '''+CAST(@batch as nvarchar(50))+''',
GETDATE() as collection_date,
	DB_ID() as database_id, 
	t.schema_id, 
	t.object_id, 
	QUOTENAME(SCHEMA_NAME(t.schema_id))+''.''+QUOTENAME(OBJECT_NAME(t.object_id)) as object_name,
	--per index data:
	i.index_id,
	i.name as index_name,
	i.allow_page_locks,
	c.legacy_col_count,
	c.xml_col_count,
	ISNULL(ius.user_scans,0) as user_scans,
	count(*) OVER (PARTITION BY t.object_id, i.index_id) as partition_count,
	--per partition data:
	p.partition_number,
	p.rows as row_count,
	CAST(ps.used_page_count * 8 / 1024.00 AS DECIMAL(10,3)) as size_mb,
	NULL as avg_fragmentation_in_percent,
	0 as analysis_status,
	vs.volume_mount_point
	
FROM 
	sys.tables t
	INNER JOIN sys.indexes i on t.object_id = i.object_id 
	INNER JOIN sys.partitions p ON p.object_id = t.object_id AND p.index_id = i.index_id
	INNER JOIN sys.allocation_units au on p.partition_id = au.container_id and au.type =1
	INNER JOIN sys.data_spaces ds on au.data_space_id = ds.data_space_id
	INNER JOIN sys.database_files dbf on dbf.data_space_id = ds.data_space_id
	CROSS APPLY sys.dm_os_volume_stats(DB_ID(),dbf.file_id) vs
	LEFT OUTER JOIN sys.dm_db_partition_stats ps on ps.object_id = t.object_id AND ps.index_id = i.index_id AND ps.partition_number = p.partition_number
	LEFT OUTER JOIN sys.dm_db_index_usage_stats ius ON ius.database_id = DB_ID() AND ius.index_id = i.index_id AND ius.object_id = i.object_id
	LEFT OUTER JOIN
	(  --number of legacy and xml columns is needed to decide if online rebuild is possible
	   --If the index is clustered, consider all columns
		SELECT 
			c.object_id, 
			i.index_id,
			ISNULL(SUM(CASE WHEN TYPE_NAME(c.system_type_id) IN (''image'',''text'',''ntext'') THEN 1 ELSE 0 END),0) as legacy_col_count,
			ISNULL(SUM(CASE WHEN TYPE_NAME(c.system_type_id) = ''xml''  THEN 1 ELSE 0 END),0) as xml_col_count
		FROM 
			sys.columns c
			INNER JOIN sys.indexes i ON i.object_id = c.object_id
			LEFT OUTER JOIN	sys.index_columns ic ON ic.object_id = c.object_id	AND ic.column_id = c.column_id AND ic.index_id = i.index_id
		WHERE
			(i.index_id = 1               -- index is clustered (count all columns)
			OR ic.index_id is not null)   -- OR nonclustered    (count only index columns)
			GROUP BY 
			c.object_id, i.index_id	
	) c ON c.index_id = i.index_id AND c.object_id = i.object_id
WHERE
	i.index_id > 0 -- we cant rebuild heap
	AND NOT EXISTS	(
		SELECT 1 
		FROM VBMS.dbo.Blacklist bl
		WHERE 
			bl.[database_id] = DB_ID()
			AND (bl.table_id = t.object_id or bl.table_id is null)
			AND (bl.index_id = i.index_id or bl.index_id is null) 
			AND (bl.subsystem_id = 1 or bl.subsystem_id is null)
			AND (bl.partition_n = p.partition_number or bl.partition_n is null)
			AND (bl.worker_name = @worker_name or worker_name is null)
			AND bl.enabled = 1)
	and ps.used_page_count > '+ CAST(@index_minsize /8*1024 as nvarchar(20)) 
EXEC(@SQL)]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexData].[@batch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexData].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[analysis_started]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CollectIndexData].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CollectIndexData].[@batch]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="352" />
				<Property Name="Length" Value="5000" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: &#xD;&#xA;Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;English:&#xD;&#xA;  &#xD;&#xA;&#xD;&#xA; &#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[CollectIndexData] &#xD;&#xA;&#x9; @db INT&#xD;&#xA;&#x9;,@batch UNIQUEIDENTIFIER = NULL&#xD;&#xA;&#x9;&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[CollectIndexFragData]">
			<Property Name="BodyScript">
				<Value><![CDATA[
SET NOCOUNT ON
DECLARE
	
	@SQL nvarchar(max),
	@locktimeout bigint
	IF @batch_id is null
		SET @batch_id = NEWID()
	
SELECT @locktimeout = int_value
FROM dbo.Parameters
WHERE parameter = 'LockTimeoutMs'	

--Удаляем устаревшие невыполненные задания / Old tasks cleanup
--DELETE
--FROM dbo.FragmentationData
--WHERE analysis_spid = @@SPID
--	and analysis_started is not null
--	AND analysis_complete is NULL
--	AND [database_id] = @db



SET @SQL = 
'USE '+QUOTENAME(DB_NAME(@db))+';

DECLARE @t1 datetime
,@timefactor float
,@exit_code int
,@Error_message nvarchar(max)

SET @t1 = DATEADD(s,'+CAST(@time_limit_s as nvarchar(255))+',GETDATE())


----Fill Fragmentation Data

SET LOCK_TIMEOUT '+CAST(@locktimeout as nvarchar(10))+';

SET NOCOUNT ON
	DECLARE @entry_id bigint, 
			@db int, 
			@table_id int,
			@index_id int, 
			@partition_id int, 
			@frag int, 
			@size_mb int,
			@batch_id uniqueidentifier
	SET @batch_id = '''+CAST(@batch_id as nvarchar(50))+'''

	DECLARE PARTS CURSOR 
	FOR SELECT entry_id, DB_ID(),object_id, index_id, partition_number, size_mb
	FROM VBMS.dbo.FragmentationData WITH (NOLOCK) where avg_fragmentation_in_percent IS NULL and database_id = DB_ID() and analysis_spid is null
	ORDER BY user_scans desc


	OPEN PARTS

	FETCH NEXT FROM PARTS
	INTO @entry_id, @db, @table_id, @index_id,@partition_id, @size_mb

	WHILE @@FETCH_STATUS=0
	BEGIN
	SET @timefactor = ISNULL(VBMS.dbo.GetTimeFactor(@db,0,@table_id,@index_id,@partition_id,1, 1,60,1),0)
	--PRINT @entry_id
	--PRINT DATEDIFF(s,@t1,(DATEADD(s,(@size_mb * @timefactor/1000),getdate())))
	--PRINT DATEADD(s,(@size_mb * @timefactor/1000),getdate())
	IF exists (select 1 FROM 
				sys.indexes i 
	INNER JOIN sys.partitions p ON p.object_id = i.object_id AND p.index_id = i.index_id
	where i.object_id = @table_id 
		AND i.index_id = @index_id
		AND p.partition_number = @partition_id)
	IF (SELECT analysis_spid FROM VBMS.dbo.FragmentationData WHERE entry_id = @entry_id ) IS NULL
		BEGIN
		IF (DATEADD(s,(@size_mb * @timefactor/1000),getdate())<@t1)
		BEGIN
			UPDATE VBMS.dbo.FragmentationData WITH (ROWLOCK)
			SET analysis_started = GETDATE(), analysis_spid = @@SPID, analysis_batch_id = @batch_id
			,analysis_time_prognosis_ms = @size_mb * @timefactor
			where entry_id = @entry_id

			SET @exit_code = 1
			SET @error_message = ''Ok''
			BEGIN TRY				 	
			SELECT @frag =  avg_fragmentation_in_percent from sys.dm_db_index_physical_stats(@db,@table_id,@index_id,@partition_id,''LIMITED'') WHERE alloc_unit_type_desc = ''IN_ROW_DATA''
			END TRY
			BEGIN CATCH

						SET @exit_code = ERROR_NUMBER()
						SET @error_message = N''Error code: '' + CAST(ERROR_NUMBER() AS NVARCHAR(10)) + N''. Error message:'' + ERROR_MESSAGE()
			END CATCH
			
			UPDATE VBMS.dbo.FragmentationData
			SET avg_fragmentation_in_percent= @frag
				,analysis_completed = getdate()
				,analysis_status = 1
				--,analysis_time_prognosis_ms = @size_mb * @timefactor
				,analysis_duration_ms = DATEDIFF(ms,analysis_started,getdate())
				,time_factor = CASE WHEN @frag is not null THEN (DATEDIFF(ms, analysis_started, GETDATE())/ (size_mb + 1.0)) ELSE NULL END
				,exit_code = @exit_code
				,exit_message = @error_message
			WHERE entry_id = @entry_id and analysis_spid = @@SPID and avg_fragmentation_in_percent is null
			IF @exit_code = 1
				BEGIN 
				exec VBMS.dbo.FillQueueIndex_async @db = @db,@batch = @batch_id, @maxdop = '+ISNULL(CAST(@maxdop as nvarchar(50)),'NULL')+', @sortintempdb = '+ISNULL(CAST(@sortintempdb as nvarchar(50)),'NULL')+', @entry_id = @entry_id
				
			
				UPDATE VBMS.dbo.FragmentationData
				SET analysis_status = 2
				WHERE entry_id = @entry_id 
				END
			ELSE
				BEGIN
				UPDATE VBMS.dbo.FragmentationData
					SET analysis_status = 3
					WHERE entry_id = @entry_id 
				END
			END
		ELSE 
			BEGIN
			--Print @entry_id
			--Print ''Skipped''
			UPDATE VBMS.dbo.FragmentationData
			SET analysis_completed = getdate()
			,analysis_duration_ms = DATEDIFF(ms,analysis_started,getdate())
			,analysis_status = -1
			,time_factor = 0
			,exit_code = -1
			,exit_message = ''Skipped. Not enough time left''
			WHERE entry_id = @entry_id and analysis_spid is null and avg_fragmentation_in_percent is null
			END
		END

		
		FETCH NEXT FROM PARTS
		INTO @entry_id, @db, @table_id, @index_id,@partition_id, @size_mb
		END

	CLOSE PARTS
	DEALLOCATE PARTS


'

EXEC (@SQL)]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexFragData].[@batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexFragData].[@db]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexFragData].[@time_limit_s]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexFragData].[@maxdop]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexFragData].[@sortintempdb]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CollectIndexFragData].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CollectIndexFragData].[@time_limit_s]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[3600]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CollectIndexFragData].[@batch_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CollectIndexFragData].[@maxdop]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CollectIndexFragData].[@sortintempdb]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="350" />
				<Property Name="Length" Value="5037" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: &#xD;&#xA;Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;English:&#xD;&#xA;&#xD;&#xA;&#xD;&#xA; &#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[CollectIndexFragData] &#xD;&#xA;&#x9;@db int&#xD;&#xA;&#x9;,@time_limit_s int = 3600&#xD;&#xA;&#x9;,@batch_id uniqueidentifier= NULL&#xD;&#xA;&#x9;,@maxdop int=  NULL&#xD;&#xA;&#x9;,@sortintempdb bit =NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[CreateWorkerAndJob]">
			<Property Name="BodyScript">
				<Value><![CDATA[
---------------------------------------------------------------------------------------------------------

IF DB_ID(@database_name) is null
	RAISERROR('Database %s does not exist',16,1,@database_name)

IF @fill_queue_time NOT LIKE '[0-9][0-9]:[0-9][0-9]'
	RAISERROR('@fill_queue_time should be in HH:MM format',16,1)

IF @start_worker_time NOT LIKE '[0-9][0-9]:[0-9][0-9]'
	RAISERROR('@start_worker_time should be in HH:MM format',16,1)

SET @worker_name = ISNULL(@worker_name,@database_name)

DELETE FROM [dbo].[Workers] WHERE worker_name = @worker_name

INSERT INTO [dbo].[Workers]
           ([worker_name]
           ,[date_added]
           ,[owner]
           ,[comment]
           ,[use_user_db]
           ,[use_system_db]
           ,[dbname_list]
           ,[except_list]
           ,[indexes]
           ,[stats]
           ,[checkall]
           ,[checktable]
           ,[checkalloc]
           ,[checkcatalog]
           ,[online_only]
           ,[afterparty]
           ,[add_stats_runtime]
           ,[totaltimemin]
           ,[indextime]
           ,[stattime]
           ,[checktime])
     VALUES 
           (@worker_name                     --Worker name
           ,getdate()                        --Creation date 
           ,SUSER_SNAME()                    --Creator
           ,'No comments'                    --Comment
           ,1                                --Process user databases
           ,0                                --0=do not process system databases
           ,@database_name                   --database name
           ,0                                --except_list=0 means that we don't want to exclude dbname from check
           ,1                                --perform index defragmentation
           ,1                                --recalculate statistics
           ,1                                --checkall=1 perform all dbcc checks
           ,1                                --checktable no effect if checkall=1
           ,1                                --checkalloc no effect if checkall=1
           ,1                                --checkcatalog no effect if checkall=1
           ,0                                --0 = perform both online and offline checks
           ,1                                --perform afterparty processing
           ,1                                --add stats during run time
           ,@total_time                      --maintenace window in minutes
           ,NULL                             --% time for index rebulds. Default value in Preferences table
           ,NULL                             --% time for statistics
           ,NULL)                            --% time for alloc

PRINT 'Worker added'
------------------------------------------------------------------------------------------------------------------------
-- 1st job

DECLARE 
	@ReturnCode INT,
	@job_id BINARY(16),
	@job_name nvarchar(300),
	@job_command  nvarchar(1000),
	@owner_login varchar(100),
	@job_start_time int

/****** Object:  Job [VBMS_FillQueueAll_CRM]    Script Date: 30.10.2014 14:49:56 ******/
BEGIN TRANSACTION


SET @ReturnCode = 0

IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'Database Maintenance' AND category_class=1)
BEGIN
	EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'Database Maintenance'
	IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
END

SET @job_name = 'VBMS_FillQueueAll_'+@worker_name
SET @job_command = N'EXEC [dbo].[FillQueueAll] @dbname_list='''+@database_name+''''
SET @owner_login = SUSER_SNAME()
SET @job_start_time = DATEPART(HOUR,@fill_queue_time)*10000+DATEPART(MINUTE,@fill_queue_time)*100


IF (EXISTS (SELECT * FROM msdb.dbo.sysjobs WHERE name = @job_name))
BEGIN
	EXEC @ReturnCode = msdb.dbo.sp_delete_job @job_name = @job_name
	IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
	PRINT 'Existing job deleted'
END

EXEC @ReturnCode =  msdb.dbo.sp_add_job 
		@job_name=@job_name,
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'Database Maintenance', 
		@owner_login_name=@owner_login, 
		@job_id = @job_id OUTPUT

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

/****** Object:  Step [Fill Queue]    Script Date: 30.10.2014 14:49:56 ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep 
		@job_id=@job_id, 
		@step_name=N'Fill Queue', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=@job_command, 
		@database_name=N'VBMS', 
		@flags=0

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

EXEC @ReturnCode = msdb.dbo.sp_update_job 
	@job_id = @job_id, 
	@start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule
		@job_id=@job_id, 
		@name=@job_name, 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20141028, 
		@active_end_date=99991231, 
		@active_start_time=@job_start_time, 
		@active_end_time=235959

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

EXEC @ReturnCode = msdb.dbo.sp_add_jobserver 
	@job_id = @job_id, 
	@server_name = N'(local)'

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

COMMIT TRANSACTION
GOTO EndSave

QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:


PRINT 'Job 1 created'
------------------------------------------------------------------------------------------------------------------------
-- 2nd job

BEGIN TRANSACTION

SET @ReturnCode = 0
SET @job_name = 'VBMS_StartWorker_'+@worker_name
SET @job_command = N'EXEC [dbo].[StartWorker] '''+@database_name+''''
SET @job_start_time = DATEPART(HOUR,@start_worker_time)*10000+DATEPART(MINUTE,@start_worker_time)*100
SET @ReturnCode = 0
SET @job_id = NULL

IF (EXISTS (SELECT * FROM msdb.dbo.sysjobs WHERE name = @job_name))
BEGIN
	EXEC @ReturnCode = msdb.dbo.sp_delete_job @job_name = @job_name
	IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
	PRINT 'Existing job deleted'
END

EXEC @ReturnCode =  msdb.dbo.sp_add_job 
		@job_name=@job_name, 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'Database Maintenance', 
		@owner_login_name=@owner_login, 
		@job_id = @job_id OUTPUT

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback2

/****** Object:  Step [Start Worker]    Script Date: 30.10.2014 15:00:35 ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep 
		@job_id=@job_id, 
		@step_name=N'Start Worker', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=@job_command, 
		@database_name=N'VBMS', 
		@flags=0

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback2

EXEC @ReturnCode = msdb.dbo.sp_update_job 
	@job_id = @job_id, 
	@start_step_id = 1

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback2

EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule 
		@job_id=@job_id, 
		@name=@job_name, 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20141028, 
		@active_end_date=99991231, 
		@active_start_time=@job_start_time, 
		@active_end_time=235959

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback2

EXEC @ReturnCode = msdb.dbo.sp_add_jobserver 
	@job_id = @job_id, 
	@server_name = N'(local)'

IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback2

COMMIT TRANSACTION

GOTO EndSave2

QuitWithRollback2:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION

EndSave2:

PRINT 'Job 2 created']]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[binary]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CreateWorkerAndJob].[@database_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CreateWorkerAndJob].[@fill_queue_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CreateWorkerAndJob].[@start_worker_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CreateWorkerAndJob].[@worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[owner]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[comment]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[use_user_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[use_system_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[dbname_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[except_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[indexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stats]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkall]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checktable]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkalloc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkcatalog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[online_only]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[afterparty]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[add_stats_runtime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[totaltimemin]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[indextime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stattime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checktime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CreateWorkerAndJob].[@total_time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[syscategories]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[syscategories].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[syscategories].[category_class]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_category]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_category].[@class]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_category].[@type]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_category].[@name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sysjobs]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sysjobs].[name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_delete_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_delete_job].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@job_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_eventlog]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_email]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_netsend]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@notify_level_page]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@delete_level]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@description]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@category_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@owner_login_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_job].[@job_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@job_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@step_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@cmdexec_success_code]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@on_success_action]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@on_success_step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@on_fail_action]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@on_fail_step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@retry_attempts]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@retry_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@os_run_priority]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@subsystem]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@command]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@database_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobstep].[@flags]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@job_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_update_job].[@start_step_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@job_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@name]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@enabled]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_type]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_subday_type]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_subday_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_relative_interval]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@freq_recurrence_factor]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_start_date]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_end_date]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_start_time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobschedule].[@active_end_time]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobserver]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobserver].[@job_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="msdb.dacpac" Name="[msdb]|[dbo].[sp_add_jobserver].[@server_name]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CreateWorkerAndJob].[@database_name]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CreateWorkerAndJob].[@fill_queue_time]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="5" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CreateWorkerAndJob].[@start_worker_time]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="5" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CreateWorkerAndJob].[@total_time]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[CreateWorkerAndJob].[@worker_name]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="478" />
				<Property Name="Length" Value="9385" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Arseny Birukov arsbir@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Процедура создает строчку в таблице Workers и пару джобов, необходимых для работы &#xD;&#xA;The procedure creates row in Workers table and a couple of jobs to run VBMS&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[CreateWorkerAndJob]&#xD;&#xA;&#x9;@database_name varchar(500)    ,      --Database to check.&#xD;&#xA;&#x9;@fill_queue_time varchar(5)    ,      --db analysis start time&#xD;&#xA;&#x9;@start_worker_time varchar(5)  ,      --maintenance window start time&#xD;&#xA;&#x9;@total_time int                ,      --Duration in minutes&#xD;&#xA;&#x9;@worker_name nvarchar(255)     = NULL     --Leave NULL to set same as db name&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DBCCChecksLog]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[rec_id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[execution_guid]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[log_date]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="12" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[error_num]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[level]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[State]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[message_text]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[repair_level]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="40" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[status]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[database_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[db_frag_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[object_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[index_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[partition_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[alloc_unit_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[rid_db_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[rid_pru_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[file]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[page]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[slot]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[ref_db_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[ref_pru_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[ref_file]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[ref_page]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[ref_slot]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DBCCChecksLog].[allocation]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="38" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DbVersion]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DbVersion].[Id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DbVersion].[Version]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="20" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DbVersion].[DateInstalled]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="40" />
		</Element>
		<Element Type="SqlDefaultConstraint" Name="[dbo].[DF_Workers_date_added]">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[(getdate())]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[Workers].[date_added]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="43" />
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[ExecuteDBCCCheck]">
			<Property Name="BodyScript">
				<Value><![CDATA[

DECLARE 
	@SQL nvarchar(max), 
	@msg nvarchar(max)
	--@sql1 nvarchar(255) 
 
 IF @exec_guid is null
	SET @exec_guid = NEWID()

 IF OBJECT_ID('tempdb..#t') IS NOT NULL
	DROP TABLE #t


IF DB_NAME(@db) is null
	RAISERROR ('Wrong database specified',16,1)

IF @action_type_id = 3 AND OBJECT_NAME(@object_id, @db) is null
BEGIN
	DECLARE @dbname sysname = DB_NAME(@db)
	RAISERROR ('Table with object_id = %d does not exist in database %s', 16, 1, @object_id, @dbname)
END


CREATE TABLE #t 
(
	[ErrorNum] [smallint] NULL,
	[Level] [tinyint] NULL,
	[State] [tinyint] NULL,
	[MessageText] [varchar](500) NULL,
	[RepairLevel] [varchar](40) NULL,
	[Status] [tinyint] NULL,
	[Dbid] [smallint] NULL,
	[DbFragId] [int] NULL,
	[ObjectId] [int] NULL,
	[IndexId] [int] NULL,
	[PartitionId] [bigint] NULL,
	[AllocUnitId] [bigint] NULL,
	[RidDbId] [int] NULL,
	[RidPruId] [int] NULL,
	[File] [int] NULL,
	[Page] [int] NULL,
	[Slot] [int] NULL,
	[RefDbId] [int] NULL,
	[RefPruId] [int] NULL,
	[RefFile] [int] NULL,
	[RefPage] [int] NULL,
	[RefSlot] [int] NULL,
	[Allocation] [int] NULL
)

SET @SQL = 
	N'USE ' + QUOTENAME(db_name(@db)) + N'; ' +
	CASE 
		WHEN @action_type_id=3 
		THEN N'DECLARE @table_name nvarchar(255)	SELECT @table_name = QUOTENAME(SCHEMA_NAME(schema_id))+''.''+QUOTENAME(name) FROM sys.objects WHERE object_id = ' + @object_id + N'; '
		ELSE N''
	END +
	N'INSERT INTO #t ' +
	CASE @action_type_id	
		WHEN 1 THEN N'EXEC(''DBCC CHECKCATALOG(['+db_name(@db)+N']) WITH NO_INFOMSGS'')'
		WHEN 2 THEN N'EXEC(''DBCC CHECKALLOC(['+db_name(@db)+N']) WITH NO_INFOMSGS, ALL_ERRORMSGS, TABLERESULTS'')'
		WHEN 3 THEN N'EXEC(''DBCC CHECKTABLE("''+@table_name+''") WITH NO_INFOMSGS, ALL_ERRORMSGS, TABLERESULTS'')'
		ELSE N'RAISERROR (''Incorrect value for parameter @action_type! 1 - CHECKCATALOG, 2 - CHECKALLOC, 3 - CHECKTABLE'',16,1)'
	END

EXEC (@SQL)

IF @@ROWCOUNT > 0
BEGIN
	SET @msg = N'Consistency check found some errors! See dbo.DBCCChecksLog table for details! execution_guid:'+cast(@exec_guid as nvarchar(40))

	IF (select @@MicrosoftVersion/0x01000000)<10
	BEGIN
		INSERT dbo.DBCCChecksLog(
			[execution_guid] , 
			log_date,
			error_num ,
			[level] ,
			[State] ,
			[message_text],
			[repair_level] ,
			[status] ,
			[database_id],
			[object_id] ,
			[index_id],
			[partition_id],
			[alloc_unit_id],
			[file],
			[page],
			[slot],
			[ref_file] ,
			[ref_page],
			[ref_slot] ,
			[allocation] 
		)
		SELECT			
			@exec_guid,
			getdate(),
			[ErrorNum] ,
			[Level] ,
			[State] ,
			[MessageText],
			[RepairLevel] ,
			[Status] ,
			[DbId],
			[ObjectId] ,
			[IndexId],
			[PartitionId],
			[AllocUnitId],
			[File],
			[Page],
			[Slot],
			[RefFile] ,
			[RefPage],
			[RefSlot] ,
			[Allocation]
		FROM #t
	END
	ELSE
	BEGIN
		INSERT dbo.DBCCChecksLog(
			[execution_guid] , 
			[log_date],
			[error_num],
			[level],
			[State],
			[message_text],
			[repair_level],
			[status],
			[database_id],
			[db_frag_id],
			[object_id],
			[index_id],
			[partition_id],
			[alloc_unit_id],
			[rid_db_id],
			[rid_pru_id],
			[file] ,
			[page] ,
			[slot] ,
			[ref_db_id],
			[ref_pru_id],
			[ref_file],
			[ref_page],
			[ref_slot],
			[allocation])
		SELECT @exec_guid,
			getdate(),
			[ErrorNum],
			[Level],
			[State],
			[MessageText],
			[RepairLevel],
			[Status],
			[Dbid],
			[DbFragId],
			[ObjectId],
			[IndexId],
			[PartitionId],
			[AllocUnitId],
			[RidDbId],
			[RidPruId],
			[File] ,
			[Page] ,
			[Slot] ,
			[RefDbId],
			[RefPruId],
			[RefFile],
			[RefPage],
			[RefSlot],
			[Allocation]
		FROM #t
	END
	RAISERROR (@msg,16,1)
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[@exec_guid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[@action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[@object_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[execution_guid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[log_date]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[error_num]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[level]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[State]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[message_text]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[repair_level]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[status]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[partition_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[alloc_unit_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[file]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[page]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[slot]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[ref_file]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[ref_page]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[ref_slot]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[allocation]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[ErrorNum]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[Level]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[State]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[MessageText]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[RepairLevel]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[Status]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[ObjectId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[IndexId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[PartitionId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[AllocUnitId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[File]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[Page]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[Slot]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[RefFile]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[RefPage]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[RefSlot]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[Allocation]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[db_frag_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[rid_db_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[rid_pru_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[ref_db_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[ref_pru_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[Dbid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[DbFragId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[RidDbId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[RidPruId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[RefDbId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ExecuteDBCCCheck].[#t].[RefPruId]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[ExecuteDBCCCheck].[#t]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[ErrorNum]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[Level]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[State]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[MessageText]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="500" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[RepairLevel]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="40" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[varchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[Status]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[tinyint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[Dbid]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[smallint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[DbFragId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[ObjectId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[IndexId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[PartitionId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bigint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[AllocUnitId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bigint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[RidDbId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[RidPruId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[File]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[Page]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[Slot]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[RefDbId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[RefPruId]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[RefFile]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[RefPage]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[RefSlot]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ExecuteDBCCCheck].[#t].[Allocation]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ExecuteDBCCCheck].[@action_type_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ExecuteDBCCCheck].[@db]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ExecuteDBCCCheck].[@object_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ExecuteDBCCCheck].[@exec_guid]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="2" />
				<Property Name="Length" Value="3918" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;CREATE PROCEDURE [dbo].[ExecuteDBCCCheck]&#xD;&#xA;&#x9;@action_type_id int = 1,&#xD;&#xA;&#x9;@db int = 1,&#xD;&#xA;&#x9;@object_id nvarchar(50) = NULL,&#xD;&#xA;&#x9;@exec_guid uniqueidentifier = NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlView" Name="[dbo].[Executions]">
			<Property Name="QueryScript">
				<Value><![CDATA[
SELECT 
	worker_name,
	[execution_id],
	ot.subsystem_name,
	ot.action_type_name,
	count(*) as total_task_count,
	count(CASE WHEN exit_code = 1 THEN 1 ELSE NULL END) as successful_task_count,
	count(CASE WHEN exit_code > 1 THEN 1 ELSE NULL END) as failed_task_count,
	count(CASE WHEN exit_code < 0 THEN 1 ELSE NULL END) as skipped_task_count,
	sum(DATEDIFF(ms,date_started, date_completed))/1000 as total_duration_s,
	sum(CASE WHEN exit_code > 1 THEN DATEDIFF(ms,date_started, date_completed) ELSE 0 END)/1000 as failed_duration_s,
	min(date_started) as first_task_started,
	max(date_completed) as last_task_completed,
	max(entry_id) as last_entry_id  --this column is needed for automated reports collection system
FROM 
	dbo.Tasks t
	INNER JOIN dbo.OperationTypes ot ON t.subsystem_id = ot.subsystem_id AND t.action_type_id = ot.action_type_id
WHERE
	[execution_id] is not null --Exclude not yet executed
GROUP BY
	[execution_id],
	worker_name,
	ot.subsystem_name,
	ot.action_type_name
--ORDER BY
--	worker_name,
--	execution_guid,
--	first_task_started]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[worker_name]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[dbo].[Tasks].[worker_name]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[execution_id]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[dbo].[Tasks].[execution_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[subsystem_name]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[dbo].[OperationTypes].[subsystem_name]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[action_type_name]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[dbo].[OperationTypes].[action_type_name]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[total_task_count]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[successful_task_count]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[failed_task_count]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[skipped_task_count]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[total_duration_s]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[failed_duration_s]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[first_task_started]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[last_task_completed]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[Executions].[last_entry_id]" />
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[OperationTypes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[OperationTypes].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[OperationTypes].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[execution_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[OperationTypes].[subsystem_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[OperationTypes].[action_type_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_started]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="449" />
				<Property Name="Length" Value="1558" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Arseny Birukov arsbir@microsoft.com&#xD;&#xA;&#xD;&#xA;Это представление показывает агрегированную статистику по выполненным таскам&#xD;&#xA;This view shows agregated statistics on executed tasks&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;CREATE VIEW Executions&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[FillQueueAll]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	SET NOCOUNT ON;
	
	DECLARE 
		@dbint_id int
		,@batch UNIQUEIDENTIFIER
		,@db INT
		,@tableid INT
		,@indexid INT
		,@partitionnum INT
		,@subsystem_id INT
		,@actiontype INT
		,@entryid BIGINT
		,@frag_collection_time_limit_s int
		,@retention DATETIME

	SET @batch = NEWID()

	IF @worker_name is NOT NULL
		IF (select latched_spid FROM dbo.Workers WHERE worker_name = @worker_name) in (0,@@SPID) or @clear_latch = 1
		BEGIN
			SELECT 
				@indexes = [indexes]
				,@stats = [stats]
				,@stats_sample =  stats_sample
				,@checkall = checkall
				,@checktable = checktable
				,@checkalloc = checkalloc
				,@checkcatalog = checkcatalog
				,@use_system_db = use_system_db
				,@use_user_db = use_user_db
				,@dbname_list = dbname_list
				,@except_list = except_list
				,@frag_collection_time_limit_s = frag_eval_time_limit_s
			FROM dbo.Workers
			WHERE worker_name = @worker_name

			UPDATE dbo.Workers
			SET latched_spid = @@SPID
			WHERE worker_name = @worker_name
		END
		ELSE
		BEGIN 
			RAISERROR('FillQueueAll is already running for this worker!',16,1);
			RETURN
		END
	
	DELETE FROM dbo.[WorkerSessions]
WHERE not exists(
	select 1 from sys.dm_exec_sessions es 
		where es.session_id = dbo.[WorkerSessions].session_id 
		and es.program_name COLLATE DATABASE_DEFAULT = dbo.[WorkerSessions].program_name COLLATE DATABASE_DEFAULT
		and es.status in ('running','runnable','suspended')
		and es.session_id <> @@SPID
		)
		
	
	IF @worker_name is not null
	INSERT dbo.[WorkerSessions] (worker_name,session_id, program_name,subsystem_id)
	select @worker_name,@@SPID, program_name,0 from sys.dm_exec_sessions where session_id=@@SPID

	IF @ix_maxdop IS NULL
		SELECT @ix_maxdop = int_value
		FROM dbo.Parameters
		WHERE parameter = 'MaxDop'

	IF @sortintempdb IS NULL
		SELECT @sortintempdb= int_value
		FROM dbo.Parameters
		WHERE parameter = 'SortInTempdb'


	IF @frag_collection_time_limit_s is NULL
		SELECT @frag_collection_time_limit_s = int_value
		FROM dbo.Parameters
		WHERE parameter = 'FragCollectionTimeLimitS'

	--Fill tasks table

	DECLARE DB CURSOR FORWARD_ONLY
	FOR 
	SELECT database_id 
	FROM dbo.GetDbList(@use_system_db, @use_user_db, @dbname_list, @except_list) t

	OPEN DB

	FETCH NEXT FROM DB INTO @dbint_id

	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF @indexes = 1 
			IF @async_frag_collection = 0
				EXEC [dbo].[FillQueueIndex] @dbint_id, @batch, @ix_maxdop, @sortintempdb
			ELSE 
				BEGIN
					DELETE
					FROM dbo.Tasks
					WHERE subsystem_id = 1
					AND date_completed IS NULL
					AND [database_id] = @dbint_id
					
				IF @collect_frag_now = 2
					BEGIN
					EXEC [dbo].[FillQueueIndex_async] @dbint_id,@batch,@ix_maxdop,@sortintempdb 
					END
				ELSE
				EXEC [dbo].[CollectIndexData] @dbint_id, @batch
				IF @collect_frag_now = 1
					BEGIN 
						EXEC [dbo].[CollectIndexFragData] @dbint_id,@frag_collection_time_limit_s,@batch,@ix_maxdop,@sortintempdb
						--EXEC [dbo].[FillQueueIndex_async] @dbint_id,@batch,@ix_maxdop,@sortintempdb
					END
				IF @collect_frag_now = 0
				PRINT 'Index frag data needs to be collected in a separate session according to @collect_frag_now = 0. 
				Collect frag data by running  dbo.CollectIndexFragData (may be run in several parallel sessions) and rerun FillQueueAll with @async_frag_collection = 1 and @collect_frag_now = 1'	
			END

		IF ((@checkall = 1 or @checktable = 1) and @checktable <> 0)
			EXEC [dbo].[FillQueueCheckTable] @dbint_id, @batch, @table_max_size_mb

		IF ((@checkall = 1 or @checkcatalog = 1 ) and @checkcatalog <> 0) 
			EXEC [dbo].[FillQueueCheckCatalog] @dbint_id, @batch

		IF ((@checkall = 1 or @checkalloc = 1) and @checkalloc <> 0)
			EXEC [dbo].[FillQueueCheckAlloc] @dbint_id, @batch

		IF (@stats = 1)
			EXEC [dbo].[FillQueueStat] @dbint_id, @batch, @sample = @stats_sample

		FETCH NEXT FROM DB INTO @dbint_id
	END

	CLOSE DB
	DEALLOCATE DB

	--Calculate the expected execution time

	DECLARE TASKS CURSOR
	FOR SELECT entry_id, [database_id], table_id,index_id,partition_n,subsystem_id, action_type_id
	FROM dbo.Tasks WHERE time_prognosis_s is null

	OPEN TASKS

	FETCH NEXT FROM TASKS
	INTO @entryid, @db, @tableid, @indexid, @partitionnum, @subsystem_id, @actiontype

	WHILE @@FETCH_STATUS = 0 
	BEGIN 

		UPDATE dbo.Tasks
		SET time_prognosis_s = ISNULL(dbo.GetTimeFactor(@db,1, @tableid, @indexid, @partitionnum, @subsystem_id, @actiontype, 60, 1), 0) * size_mb
		WHERE entry_id = @entryid

		FETCH NEXT FROM TASKS
		INTO @entryid, @db, @tableid, @indexid, @partitionnum, @subsystem_id, @actiontype

	END

	CLOSE TASKS

	DEALLOCATE TASKS

	UPDATE dbo.Workers
		SET latched_spid = 0
		WHERE worker_name = @worker_name

	SELECT @batch as BatchId

	IF @debug = 1
	BEGIN
		SELECT 'Frag analysis results' as [-----]
		SELECT * FROM dbo.FragmentationData where batch_id = @batch
		SELECT 'Tasks generated' as [-----]
		SELECT * from dbo.Tasks where batch_id = @batch
	END


--Удаление старых записей / Removing old records
IF EXISTS (SELECT 1 FROM dbo.Parameters WHERE parameter = 'HistoryRetentionDays' and int_value is not null )
	SELECT @retention = dateadd(DD,-int_value,getdate()) 
	FROM dbo.Parameters
	WHERE parameter = 'HistoryRetentionDays'

IF EXISTS (SELECT 1 FROM dbo.Parameters WHERE parameter = 'HistoryRetentionDays' and int_value is not null )
BEGIN
	DELETE FROM dbo.Tasks
	WHERE date_added < @retention

	DELETE FROM dbo.DBCCChecksLog
	WHERE log_date < @retention

	DELETE FROM dbo.FragmentationData
	WHERE collection_date < @retention
END
DELETE FROM dbo.WorkerSessions where worker_name = @worker_name and subsystem_id = 0

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[latched_spid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@clear_latch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@indexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[indexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@stats]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stats]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@stats_sample]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stats_sample]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@checkall]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkall]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@checktable]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checktable]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@checkalloc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkalloc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@checkcatalog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkcatalog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@use_system_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[use_system_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@use_user_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[use_user_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@dbname_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[dbname_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@except_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[except_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[frag_eval_time_limit_s]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[latched_spid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[program_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[program_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[status]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[program_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[subsystem_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[program_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@ix_maxdop]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@sortintempdb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDbList]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDbList].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@async_frag_collection]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@collect_frag_now]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexData]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CollectIndexFragData]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@table_max_size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckCatalog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckAlloc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueStat]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueStat].[@sample]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[time_prognosis_s]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueAll].[@debug]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DBCCChecksLog].[log_date]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[collection_date]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@worker_name]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@indexes]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@async_frag_collection]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@collect_frag_now]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@stats]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@stats_sample]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA['RESAMPLE']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@checkall]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@checktable]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@table_max_size_mb]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1000000]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@checkalloc]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@checkcatalog]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@use_user_db]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@use_system_db]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@dbname_list]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA['']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@except_list]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@sortintempdb]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@ix_maxdop]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@clear_latch]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueAll].[@debug]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="445" />
				<Property Name="Length" Value="7175" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#x9;&#x9;Arseny Birukov arsbir@microsoft.com&#xD;&#xA;&#xD;&#xA;Procedure is a wrapper for FillQueueXXX procedures that passes neccessary parameters to them.&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[FillQueueAll] &#xD;&#xA;&#x9;-- Add the parameters for the stored procedure here&#xD;&#xA;&#x9;@worker_name nvarchar(50) = NULL, --generate tasks only for a specific worker profile.&#xD;&#xA;&#x9;@indexes bit = 1,&#xD;&#xA;&#x9;@async_frag_collection bit =1,&#xD;&#xA;&#x9;@collect_frag_now int =1, -- 0-dont collect frag data, only prepare indexes list, 1- prepare indexes list, collect frag data and generate tasks in this session. 2 - Indexes list with frag data has been filled already, need just to prepare the tasks. &#xD;&#xA;&#x9;@stats bit = 0,&#xD;&#xA;&#x9;@stats_sample nvarchar(50) = 'RESAMPLE',&#xD;&#xA;&#x9;@checkall bit = 1,&#xD;&#xA;&#x9;@checktable bit = 0,&#xD;&#xA;&#x9;@table_max_size_mb bigint = 1000000,&#xD;&#xA;&#x9;@checkalloc bit = 0,&#xD;&#xA;&#x9;@checkcatalog bit = 0,&#xD;&#xA;&#x9;@use_user_db bit = 1,&#xD;&#xA;&#x9;@use_system_db bit = 0,&#xD;&#xA;&#x9;@dbname_list nvarchar(500) = '',&#xD;&#xA;&#x9;@except_list bit =0, --invert database selection list&#xD;&#xA;&#x9;@sortintempdb bit = NULL,&#xD;&#xA;&#x9;@ix_maxdop int = NULL, --override global settings maxDOP.&#x9;&#xD;&#xA;&#x9;@clear_latch bit = 0&#xD;&#xA;&#x9;,@debug bit = 0&#xD;&#xA;&#x9;&#xD;&#xA;&#x9;&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[FillQueueCheckAlloc]">
			<Property Name="BodyScript">
				<Value><![CDATA[

DECLARE	@SQL NVARCHAR(MAX)


DECLARE @check_interval int
SELECT @check_interval = int_value
FROM dbo.Parameters where parameter = 'CheckAllocIntervalDays'

DECLARE @worker_name nvarchar(255)
SELECT @worker_name = worker_name
FROM dbo.WorkerSessions
WHERE session_id = @@SPID

DELETE
FROM dbo.Tasks
WHERE subsystem_id = 3 --Подсистема проверки целостности / subsystem_id 3 is an integrity check
	AND action_type_id = 2 -- CHECKALLOC
	AND date_completed IS NULL
	AND [database_id] = @db

DECLARE @last_check datetime

SELECT 
	@last_check = MAX(date_completed)
FROM dbo.Tasks
WHERE database_id = @db
	AND subsystem_id = 3
	AND action_type_id = 2
	AND exit_code = 1


IF 
	DATEDIFF(dd,ISNULL(@last_check,0),getdate()) > @check_interval
	AND NOT EXISTS (SELECT 1 
		FROM dbo.Blacklist bl
		WHERE 
			bl.database_id = @db
			AND (bl.subsystem_id = 3 or bl.subsystem_id is null)
			AND (bl.action_type_id = 2 or action_type_id is null)
			AND (bl.worker_name = @worker_name or worker_name is null)
			AND bl.enabled = 1)

INSERT INTO dbo.Tasks (
	[batch_id]
	,[subsystem_id]
	,[action_type_id]
	,[command]
	,[date_added]
	,[database_id]
	,[size_mb]
	,[checked_daysago]
)
SELECT
	@batch
	,3
	,2 
	,'USE [VBMS]; EXEC [dbo].[ExecuteDBCCCheck] @action_type_id = 2, @db = '+cast(@db as nvarchar(3))+'--DBCC CHECKALLOC(['+db_name(@db)+']) WITH NO_INFOMSGS'
	,getdate()
	,@db
	,sum(CAST(ps.used_page_count * 8 / 1024.00 AS DECIMAL(10, 3)))
	,DATEDIFF(dd,@last_check,getdate())
from 
	sys.dm_db_partition_stats ps]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckAlloc].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[enabled]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[command]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[checked_daysago]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_db_partition_stats]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckAlloc].[@batch]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[decimal]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_db_partition_stats].[used_page_count]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueCheckAlloc].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueCheckAlloc].[@batch]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="1066" />
				<Property Name="Length" Value="2711" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;/*&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;Russian version:&#xD;&#xA;&#xD;&#xA;Процедура формирования заданий проверки целостности БД с точки зрения аллокации.&#xD;&#xA;Задание представляет собой выражение DBCC CHECKALLOC('&lt;имя БД&gt;').&#xD;&#xA;Отбираются БД не проверявшиеся более чем количество дней, заданное параметром CheckAllocIntervalDays в таблице Parameters.&#xD;&#xA;Задания упорядочиваются по давности последней проверки или размеру БД.&#xD;&#xA;&#xD;&#xA;Englsh version:&#xD;&#xA;&#xD;&#xA;Procedure creates a tasks of integrity checks of DB extents allocation.&#xD;&#xA;Tasks are statements like DBCC CHECKALLOC('&lt;DB name&gt;').&#xD;&#xA;Databases are being scheduled for check if they have not been checked for more than X days,&#xD;&#xA;where X is a value of CheckAllocIntervalDays parameter in dbo.Parameters table.&#xD;&#xA;Tasks are sorted by date of last check and/or DB size Mb.&#xD;&#xA;  &#xD;&#xA;&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[FillQueueCheckAlloc] @db INT, @batch UNIQUEIDENTIFIER&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[FillQueueCheckCatalog]">
			<Property Name="BodyScript">
				<Value><![CDATA[

--Считываем параметры / Loading parameters
DECLARE @check_interval int
SELECT @check_interval = int_value
FROM dbo.Parameters where parameter = 'CheckCatalogIntervalDays'

DECLARE @worker_name nvarchar(255)
SELECT @worker_name = worker_name
FROM dbo.WorkerSessions
WHERE session_id = @@SPID

--Удаляем устаревшие невыполненные задания / Old tasks cleanup
DELETE
FROM dbo.Tasks
WHERE subsystem_id = 3     --Подсистема проверки целостности / subsystem_id 3 is an integrity check
	AND action_type_id = 1 -- CHECKCATALOG
	AND date_completed IS NULL
	AND [database_id] = @db

DECLARE @last_check datetime

SELECT 
	@last_check = MAX(date_completed)
FROM dbo.Tasks
WHERE database_id = @db
	AND subsystem_id = 3
	AND action_type_id = 1
	AND exit_code = 1


IF 
	DATEDIFF(dd,ISNULL(@last_check,0),getdate()) > @check_interval
	AND NOT EXISTS (SELECT 1 
		FROM dbo.Blacklist bl
		WHERE 
			bl.database_id = @db
			AND (bl.subsystem_id = 3 or bl.subsystem_id is null)
			AND (bl.action_type_id = 1 or action_type_id is null)
			AND (bl.worker_name = @worker_name or worker_name is null)
			AND bl.enabled = 1)

INSERT INTO dbo.Tasks (
	[batch_id]
	,[subsystem_id]
	,[action_type_id]
	,[command]
	,[date_added]
	,[database_id]
	,[size_mb]
	,[checked_daysago]
)
SELECT
	@batch
	,3
	,1 
	,'USE [VBMS]; EXEC [dbo].[ExecuteDBCCCheck] @action_type_id = 1, @db = '+cast(@db as nvarchar(3))+'--DBCC CHECKCATALOG(['+db_name(@db)+']) WITH NO_INFOMSGS'
	,getdate()
	,@db
	,5.0 --system catalog is usually 2-10 Mb for all DBs. Size does not really matter.
	,DATEDIFF(dd,@last_check,getdate())]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckCatalog].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[enabled]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[command]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[checked_daysago]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckCatalog].[@batch]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueCheckCatalog].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueCheckCatalog].[@batch]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="1048" />
				<Property Name="Length" Value="2763" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian version:&#xD;&#xA;&#xD;&#xA;Процедура формирования заданий проверки целостности системного каталога БД.&#xD;&#xA;Задание представляет собой выражение DBCC CHECKCATALOG('&lt;имя БД&gt;').&#xD;&#xA;Отбираются БД не проверявшиеся более чем количество дней, заданное параметром CheckCatalogIntervalDays в таблице Parameters.&#xD;&#xA;Задания упорядочиваются по давности последней проверки и размеру БД.&#xD;&#xA;&#xD;&#xA;Englsh version:&#xD;&#xA;&#xD;&#xA;Procedure creates a tasks of integrity checks of system tables.&#xD;&#xA;Tasks are statements like DBCC CHECKTABLE('&lt;DB name&gt;').&#xD;&#xA;Databases are being scheduled for check if they have not been checked for more than X days,&#xD;&#xA;where X is a value of CheckCatalogIntervalDays parameter in dbo.Parameters table.&#xD;&#xA;Tasks are sorted by date of last check and DB size Mb.&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[FillQueueCheckCatalog] @db INT, @batch UNIQUEIDENTIFIER&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[FillQueueCheckTable]">
			<Property Name="BodyScript">
				<Value><![CDATA[

DECLARE	@SQL NVARCHAR(MAX)

DECLARE @check_interval int

SELECT @check_interval = int_value
FROM dbo.Parameters where parameter = 'CheckTableIntervalDays'


DECLARE @worker_name nvarchar(255)
SELECT @worker_name = worker_name
FROM dbo.WorkerSessions
WHERE session_id = @@SPID

IF @table_max_size_mb = 0
	SET @table_max_size_mb = 1000000

DELETE
FROM dbo.Tasks
WHERE subsystem_id = 3 --Тип действия Проверка целостности таблиц / subsystem_id 3 is an integrity check
	AND action_type_id = 3
	AND date_completed IS NULL
	AND [database_id] = @db


DECLARE @tables TABLE
(
	database_id int,
	schema_id int,
	object_id int,
	object_name nvarchar(4000),
	row_count bigint,
	size_mb decimal(10, 3)
)

SET @SQL = 
'USE '+QUOTENAME(DB_NAME(@db))+
'SELECT 
	DB_ID() as database_id, 
	t.schema_id, 
	t.object_id, 
	QUOTENAME(SCHEMA_NAME(t.schema_id))+''.''+QUOTENAME(OBJECT_NAME(t.object_id)) as object_name,
	sum(p.rows) as row_count,
	sum(CAST(ps.used_page_count * 8 / 1024.00 AS decimal(10, 3))) as size_mb
	
FROM 
	sys.tables t
	INNER JOIN sys.indexes i on t.object_id = i.object_id and i.index_id < 2 --Heap or clustered index
	INNER JOIN sys.partitions p ON p.object_id = t.object_id AND p.index_id = i.index_id
	LEFT JOIN sys.dm_db_partition_stats ps on ps.object_id = t.object_id AND ps.index_id = i.index_id AND ps.partition_number = p.partition_number
WHERE rows > 0
GROUP BY 
	t.schema_id, 
	t.object_id'
	
INSERT INTO @tables
EXEC (@SQL)


INSERT dbo.Tasks (
	[batch_id]
	,[subsystem_id]
	,[action_type_id]
	,[command]
	,[date_added]
	,[database_id]
	,[table_id]
	,[rowcnt]
	,[size_mb]
	,[checked_daysago]
)
SELECT
	@batch
	,3
	,3 
	,N'USE [VBMS]; EXEC [dbo].[ExecuteDBCCCheck] @action_type_id = 3, @db = '+cast(@db as nvarchar(4))+', @object_id = '+cast(nt.object_id as nvarchar(20)) +'; --DBCC CHECKTABLE('+nt.object_name+') WITH NO_INFOMSGS'
	,getdate()
	,@db
	,nt.object_id
	,nt.row_count
	,nt.size_mb
	,DATEDIFF(dd,pt.date_completed,getdate())
FROM
	@tables nt 
	LEFT OUTER JOIN
	( 
		SELECT 
			ROW_NUMBER() OVER (PARTITION BY table_id order by date_completed DESC) AS rn,
			table_id,
			date_completed
		FROM  
			dbo.Tasks
		WHERE 
			subsystem_id = 3
			AND action_type_id = 3
			AND database_id = @db
			AND exit_code = 1
	) pt ON pt.table_id = nt.object_id
WHERE
	ISNULL(nt.size_mb,0) < @table_max_size_mb
	AND (pt.rn = 1 OR pt.rn is null) --last row or nothing
	AND (DATEDIFF(dd,ISNULL(pt.date_completed,0),getdate()) > @check_interval OR pt.date_completed is null)
	AND NOT EXISTS
		(
			SELECT 1 
			FROM dbo.Blacklist bl
			WHERE 
				bl.database_id = @db 
				and (bl.table_id = nt.object_id or bl.table_id is null)
				and (bl.subsystem_id = 3 or bl.subsystem_id is null)
				and (bl.action_type_id = 3 or action_type_id is null)
				AND (bl.worker_name = @worker_name or worker_name is null)
				and bl.enabled = 1
		)]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable].[@table_max_size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[command]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[rowcnt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[checked_daysago]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable].[@tables].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable].[@batch]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable].[@tables].[object_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable].[@tables].[row_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable].[@tables].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueCheckTable].[@tables].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[FillQueueCheckTable].[@tables]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueCheckTable].[@tables].[database_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueCheckTable].[@tables].[schema_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueCheckTable].[@tables].[object_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueCheckTable].[@tables].[object_name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="4000" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueCheckTable].[@tables].[row_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bigint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueCheckTable].[@tables].[size_mb]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Scale" Value="3" />
												<Property Name="Precision" Value="10" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[decimal]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueCheckTable].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueCheckTable].[@batch]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueCheckTable].[@table_max_size_mb]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1000000]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="1059" />
				<Property Name="Length" Value="4193" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian version:&#xD;&#xA;&#xD;&#xA;Процедура формирования заданий проверки целостности отдельных таблиц.&#xD;&#xA;Задание представляет собой выражение DBCC CHECKTABLE('&lt;имя таблицы&gt;').&#xD;&#xA;Отбираются таблицы не проверявшиеся более чем количество дней, заданное параметром CheckTableIntervalDays в таблице Parameters.&#xD;&#xA;Таблицы упорядочиваются по давности последней проверки и размеру таблицы.&#xD;&#xA;&#xD;&#xA;Englsh version:&#xD;&#xA;&#xD;&#xA;Procedure creates a tasks of integrity checks for perticular tables.&#xD;&#xA;Tasks are statements like DBCC CHECKTABLE('&lt;Table name&gt;').&#xD;&#xA;Tables are being scheduled for check if they have not been checked for more than X days,&#xD;&#xA;where X is a value of CheckTableIntervalDays parameter in dbo.Parameters table.&#xD;&#xA;Tasks are sorted by date of last check and table size Mb.&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[FillQueueCheckTable] &#xD;&#xA;&#x9;@db INT, &#xD;&#xA;&#x9;@batch UNIQUEIDENTIFIER, &#xD;&#xA;&#x9;@table_max_size_mb bigint = 1000000 --exclude bigger tables. By default no more than 1 Pb&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[FillQueueIndex]">
			<Property Name="BodyScript">
				<Value><![CDATA[



DECLARE
	@reorg_threshold decimal(10,3),
	@frag_threshold bigint,
	@locktimeout bigint,
	@online_allowed bit,
	@SQL nvarchar(max),
	@index_minsize bigint
	
DECLARE @worker_name nvarchar(255)
SELECT @worker_name = worker_name
FROM dbo.WorkerSessions
WHERE session_id = @@SPID

--Удаляем устаревшие невыполненные задания / Old tasks cleanup
DELETE
FROM dbo.Tasks
WHERE subsystem_id = 1
	AND date_completed IS NULL
	AND [database_id] = @db

--Считываем параметры / Loading parameters
SELECT @reorg_threshold = int_value
FROM dbo.Parameters
WHERE parameter = 'IndexReorgThresholdPercent'

SELECT @locktimeout = int_value
FROM dbo.Parameters
WHERE parameter = 'LockTimeoutMs'

SELECT @frag_threshold = int_value
FROM dbo.Parameters
WHERE parameter = 'IndexFragLowerThreshold'

SELECT @index_minsize = int_value
FROM dbo.Parameters
WHERE parameter = 'IndexMinimumSizeMB'


IF (CAST(SERVERPROPERTY('Edition') as NVARCHAR(50)) LIKE N'%Enterprise%'
  OR CAST(SERVERPROPERTY('Edition') as NVARCHAR(50)) LIKE N'%Datecenter%'
  OR CAST(SERVERPROPERTY('Edition') as NVARCHAR(50)) LIKE N'%Developer%')
	SELECT @online_allowed = int_value
	FROM dbo.Parameters
	WHERE parameter = 'IndexOnlineRebuild'
ELSE 
	SET @online_allowed = 0

--Get list of all partitions and some stats on them
--This statement should be executed in different database context, so we have to use dynamic T-SQL
--The statement itself is static, it's relatively easy to unquote it
SET @SQL = 
'USE '+QUOTENAME(DB_NAME(@db))+';

IF OBJECT_ID(''tempdb..#frag_data'') is not null
	DROP TABLE #frag_data
SELECT 
	DB_ID() as database_id, 
	t.schema_id, 
	t.object_id, 
	QUOTENAME(SCHEMA_NAME(t.schema_id))+''.''+QUOTENAME(OBJECT_NAME(t.object_id)) as object_name,
	--per index data:
	i.index_id,
	i.name as index_name,
	i.allow_page_locks,
	--c.legacy_col_count,
	--c.xml_col_count,
	ISNULL(ius.user_scans,0) as user_scans,
	count(*) OVER (PARTITION BY t.object_id, i.index_id) as partition_count,
	--per partition data:
	p.partition_number,
	p.rows as row_count,
	CAST(ps.used_page_count * 8 / 1024.00 AS DECIMAL(10,3)) as size_mb,
	CAST(ips.avg_fragmentation_in_percent as DECIMAL(10,3)) as avg_fragmentation_in_percent
INTO #frag_data
FROM 
	sys.tables t
	INNER JOIN sys.indexes i on t.object_id = i.object_id 
	INNER JOIN sys.partitions p ON p.object_id = t.object_id AND p.index_id = i.index_id
	LEFT OUTER JOIN sys.dm_db_partition_stats ps on ps.object_id = t.object_id AND ps.index_id = i.index_id AND ps.partition_number = p.partition_number
	LEFT OUTER JOIN sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, ''LIMITED'') ips ON ips.object_id = i.object_id AND ips.index_id = i.index_id AND ips.partition_number = p.partition_number AND alloc_unit_type_desc = ''IN_ROW_DATA''
	LEFT OUTER JOIN sys.dm_db_index_usage_stats ius ON ius.database_id = DB_ID() AND ius.index_id = i.index_id AND ius.object_id = i.object_id
	--LEFT OUTER JOIN
	--(  --number of legacy and xml columns is needed to decide if online rebuild is possible
	--   --If the index is clustered, consider all columns
	--	SELECT 
	--		c.object_id, 
	--		i.index_id,
	--		ISNULL(SUM(CASE WHEN TYPE_NAME(c.system_type_id) IN (''image'',''text'',''ntext'') THEN 1 ELSE 0 END),0) as legacy_col_count,
	--		ISNULL(SUM(CASE WHEN TYPE_NAME(c.system_type_id) = ''xml''  THEN 1 ELSE 0 END),0) as xml_col_count
	--	FROM 
	--		sys.columns c
	--		INNER JOIN sys.indexes i ON i.object_id = c.object_id
	--		LEFT OUTER JOIN	sys.index_columns ic ON ic.object_id = c.object_id	AND ic.column_id = c.column_id AND ic.index_id = i.index_id
	--	WHERE
	--		(i.index_id = 1               -- index is clustered (count all columns)
	--		OR ic.index_id is not null)   -- OR nonclustered    (count only index columns)
	--		GROUP BY 
	--		c.object_id, i.index_id	
	--) c ON c.index_id = i.index_id AND c.object_id = i.object_id
WHERE
	i.index_id > 0 -- we cant rebuild heap
	and ps.used_page_count > ' + CAST(@index_minsize /8 * 1024 as NVARCHAR(10))+ '
	and ips.avg_fragmentation_in_percent >' + CAST(@frag_threshold as NVARCHAR(10))+'

SELECT  
i.database_id,
i.schema_id,
i.object_id,
i.object_name,
i.index_id,
i.index_name,
i.allow_page_locks,
c.legacy_col_count,
c.xml_col_count,
i.user_scans,
i.partition_count,
i.partition_number,
i.row_count,
i.size_mb,
i.avg_fragmentation_in_percent

FROM #frag_data i
LEFT OUTER JOIN
	(  --number of legacy and xml columns is needed to decide if online rebuild is possible
	   --If the index is clustered, consider all columns
		SELECT 
			c.object_id, 
			i.index_id,
			ISNULL(SUM(CASE WHEN TYPE_NAME(c.system_type_id) IN (''image'',''text'',''ntext'') THEN 1 ELSE 0 END),0) as legacy_col_count,
			ISNULL(SUM(CASE WHEN TYPE_NAME(c.system_type_id) = ''xml''  THEN 1 ELSE 0 END),0) as xml_col_count
		FROM 
			sys.columns c
			INNER JOIN sys.indexes i ON i.object_id = c.object_id
			LEFT OUTER JOIN	sys.index_columns ic ON ic.object_id = c.object_id	AND ic.column_id = c.column_id AND ic.index_id = i.index_id
		WHERE
			(i.index_id = 1               -- index is clustered (count all columns)
			OR ic.index_id is not null)   -- OR nonclustered    (count only index columns)
			GROUP BY 
			c.object_id, i.index_id	
	) c ON c.index_id = i.index_id AND c.object_id = i.object_id

DROP TABLE #frag_data



'
IF OBJECT_ID('tempdb..#partitions') is not null
	DROP TABLE #partitions

CREATE TABLE #partitions
(
	database_id int, 
	schema_id int,  
	object_id int, 
	object_name nvarchar(4000),
	index_id int,
	index_name nvarchar(4000),
	allow_page_locks bit,
	legacy_col_count int,
	xml_col_count int,
	user_scans bigint,
	partition_count int,
	partition_number int,
	row_count bigint,
	size_mb decimal(10,3),
	avg_fragmentation_in_percent decimal(10,3)
)

INSERT INTO #partitions
EXEC (@SQL)



INSERT dbo.Tasks (
	batch_id
	,subsystem_id
	,action_type_id
	,command
	,date_added
	,[database_id]
	,table_id
	,index_id
	,partition_n
	,[maxdop]
	,ix_frag
	,user_seeks
	,user_scans
	,user_updates
	,rowcnt
	,size_mb
	,[priority]
)
SELECT
	@batch,
	1,  --index maintenance
	t.action_type_id,
	t.command,
	getdate(),
	@db,
	t.object_id,
	t.index_id,
	t.partition_number,
	t.maxdop,
	t.avg_fragmentation_in_percent,
	NULL, --removed seeks - useless
	t.user_scans,
	NULL, --removed updates
	t.row_count,
	t.size_mb,
	CASE WHEN ISNULL(pt.exit_code,1) <> 1 THEN 2 ELSE 1 END --Если предыдущий таск завершился с ошибкой понижаем этму приоритет
FROM
	(
		SELECT
			CASE 
				WHEN t.action = N'REBUILD' AND t.online LIKE N'OFF%' THEN 1
				WHEN t.action = N'REBUILD' AND t.online is null THEN 1
				WHEN t.action = N'REBUILD' AND t.online LIKE N'ON%' THEN 2
				WHEN t.action = N'REORGANIZE' THEN 3
			END as action_type_id,
			--Конструирую выражение / Assembling statement
			N'USE ' + QUOTENAME(DB_NAME(@db)) + N'; ' +
			CASE WHEN @locktimeout<60000 or (@@MicrosoftVersion/0x01000000)<12 THEN N'SET LOCK_TIMEOUT ' + t.lock_timeout + N'; ' ELSE '' END +
			N'ALTER INDEX [' + t.index_name + N'] ON '+ t.object_name + N' ' + t.action + N' ' + t.partition_spec +
			CASE WHEN t.action = N'REBUILD' THEN N'WITH ('+COALESCE('ONLINE='+ t.online,'') +N'SORT_IN_TEMPDB='+ t.sort_in_tempdb + N'MAXDOP='+ t.maxdop + N')' ELSE N'' END + N';' --rebuild options
			as command,
			*
		FROM
			(	--Подготавливаю опции / prepare options for the statement
				SELECT 
					--REORG or REBUILD:
					CASE WHEN avg_fragmentation_in_percent > @reorg_threshold THEN N'REBUILD' ELSE N'REORGANIZE' END as [action],
					--If we have multiple partitions, specify the partition number
					CASE WHEN partition_count > 1 THEN N' PARTITION = ' + CAST(partition_number as nvarchar(10)) ELSE N'' END + N' ' as partition_spec,
					--Sort in tempdb determined by global option
					CASE WHEN @sortintempdb = 1 THEN N'ON, ' ELSE N'OFF, ' END [sort_in_tempdb],
					--If possible, perform online rebuild
					CASE 
						WHEN @online_allowed = 0 THEN N'OFF, /*disabled*/ '  --online is disabled in settings
						WHEN legacy_col_count > 0 THEN N'OFF, /*legacy*/ ' --legacy column types can't be rebuilt online
						WHEN xml_col_count > 0 AND (@@MicrosoftVersion/0x01000000)<11 THEN N'OFF, /*xml*/ ' --xml columns can't be rebuild online prior to 2012
						--WHEN partition_count = 1 THEN NULL --one partition can't be rebuild online and even OFF is incorrect
						WHEN partition_count > 1 AND (@@MicrosoftVersion/0x01000000)<12 THEN NULL --prior to SQL 2014 partitions could not be rebuilt online and even OFF is incorrect
						ELSE --We can use online rebuild
							CASE 
							--Starting from 2014 rebuild can wait at low priority:
								WHEN (@@MicrosoftVersion/0x01000000)>=12 and @locktimeout > 60000 /*more than a minute */ THEN N'ON (WAIT_AT_LOW_PRIORITY ( MAX_DURATION = '+cast(@locktimeout/60000 as nvarchar(20))+' , ABORT_AFTER_WAIT = SELF ) ),' 
								
								ELSE N'ON, ' --Simply online
								
								
							END

					END as [online],
					--Lock timeout from global settings
					CAST(@locktimeout as nvarchar(10)) as [lock_timeout],
					--Set maxdop if page locks are not prohibited. See  http://support.microsoft.com/kb/2292737 
					CASE 
						WHEN [allow_page_locks] = 1 OR (@@MicrosoftVersion/0x01000000)>=11  THEN  CAST(ISNULL(@maxdop,1) AS nvarchar(10))
						--WHEN @allow_pl = 0 AND (@@MicrosoftVersion/0x01000000)<11 THEN N'1' 
						ELSE N'1'
					END as [maxdop],
					*
				FROM 
					#partitions p
			) t
	) t
	OUTER APPLY --находим такой же предыдущий таск / Find similar prevous task 
	(
		SELECT TOP 1 pt.exit_code 
		FROM
			dbo.Tasks pt
		WHERE
			pt.subsystem_id = 1 
			AND pt.action_type_id = t.action_type_id
			AND pt.database_id = t.database_id
			AND pt.table_id = t.object_id
			AND pt.index_id = t.index_id
			AND pt.partition_n = t.partition_number
			AND pt.date_completed is not null
		ORDER BY
			pt.date_completed DESC
	) pt
WHERE
	--Фрагментация выше порога / Fragmentation above threshold
	t.avg_fragmentation_in_percent > @frag_threshold
	AND size_mb > @index_minsize
	AND	NOT EXISTS	(
		SELECT 1 
		FROM dbo.Blacklist bl
		WHERE 
			bl.[database_id] = @db 
			AND (bl.table_id = t.object_id or bl.table_id is null)
			AND (bl.index_id = t.index_id or bl.index_id is null) 
			AND (bl.subsystem_id = 1 or bl.subsystem_id is null)
			AND (bl.action_type_id = t.action_type_id or bl.action_type_id is null)
			AND (bl.partition_n = t.partition_number or bl.partition_n is null)
			AND (bl.worker_name = @worker_name or worker_name is null)
			AND bl.enabled = 1
	)
ORDER BY 
	t.user_scans DESC,
	t.avg_fragmentation_in_percent DESC,
	t.size_mb DESC]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[decimal]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[command]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[maxdop]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[ix_frag]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[user_seeks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[user_scans]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[user_updates]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[rowcnt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[priority]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[avg_fragmentation_in_percent]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[partition_count]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[@sortintempdb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[legacy_col_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[xml_col_count]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[allow_page_locks]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[@maxdop]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[index_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[object_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[@batch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[avg_fragmentation_in_percent]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[user_scans]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[row_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex].[#partitions].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[FillQueueIndex].[#partitions]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[database_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[schema_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[object_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[object_name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="4000" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[index_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[index_name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="4000" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[allow_page_locks]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[legacy_col_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[xml_col_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[user_scans]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bigint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[partition_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[partition_number]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[row_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bigint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[size_mb]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Scale" Value="3" />
												<Property Name="Precision" Value="10" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[decimal]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex].[#partitions].[avg_fragmentation_in_percent]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Scale" Value="3" />
												<Property Name="Precision" Value="10" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[decimal]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex].[@batch]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex].[@maxdop]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex].[@sortintempdb]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="1113" />
				<Property Name="Length" Value="12074" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: &#xD;&#xA;Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;Arseny Birukov arsbir@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;&#xD;&#xA;Процедура формирования заданий обслуживания индексов на основе их состояния. &#xD;&#xA;Задания - выражения для обслуживания отдельных индексов - добавляются в таблицу dbo.Tasks&#xD;&#xA;Применяется оценка процента фрагментации и возможности перестройки индекса онлайн.&#xD;&#xA;Для приоритезации заданий используется частота обращений к индексу (только user_scan), фрагментация и размер индекса.  &#xD;&#xA;&#xD;&#xA;English:&#xD;&#xA;&#xD;&#xA;Stored procedure creates tasks for index maintenance based on their state and operational stats.&#xD;&#xA;Tasks are T-SQL statements of index REBUILD/REORGANIZE, that are inserted in dbo.Tasks table.&#xD;&#xA;Index is evaluated by frag percent, user scans counter and size. &#xD;&#xA;First goes the most used (user scans) index with higher fragmentation and the larger size.   &#xD;&#xA;&#xD;&#xA; &#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[FillQueueIndex] &#xD;&#xA;&#x9; @db INT&#xD;&#xA;&#x9;,@batch UNIQUEIDENTIFIER&#xD;&#xA;&#x9;,@maxdop INT = NULL&#xD;&#xA;&#x9;,@sortintempdb BIT = NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[FillQueueIndex_async]">
			<Property Name="BodyScript">
				<Value><![CDATA[



DECLARE
	@reorg_threshold decimal(10,3),
	@frag_threshold bigint,
	@locktimeout bigint,
	@online_allowed bit,
	@SQL nvarchar(max),
	@index_minsize bigint
	
DECLARE @worker_name nvarchar(255)
SELECT @worker_name = worker_name
FROM dbo.WorkerSessions
WHERE session_id = @@SPID


--Считываем параметры / Loading parameters
SELECT @reorg_threshold = int_value
FROM dbo.Parameters
WHERE parameter = 'IndexReorgThresholdPercent'

SELECT @locktimeout = int_value
FROM dbo.Parameters
WHERE parameter = 'LockTimeoutMs'

SELECT @frag_threshold = int_value
FROM dbo.Parameters
WHERE parameter = 'IndexFragLowerThreshold'


SELECT @index_minsize = int_value
FROM dbo.Parameters
WHERE parameter = 'IndexMinimumSizeMB'

IF @maxdop is null
SELECT @maxdop = int_value
		FROM dbo.Parameters
		WHERE parameter = 'MaxDop'

IF @sortintempdb IS NULL
		SELECT @sortintempdb= int_value
		FROM dbo.Parameters
		WHERE parameter = 'SortInTempdb'


IF (CAST(SERVERPROPERTY('Edition') as NVARCHAR(50)) LIKE N'%Enterprise%'
  OR CAST(SERVERPROPERTY('Edition') as NVARCHAR(50)) LIKE N'%Datacenter%'
  OR CAST(SERVERPROPERTY('Edition') as NVARCHAR(50)) LIKE N'%Developer%')
	SELECT @online_allowed = int_value
	FROM dbo.Parameters
	WHERE parameter = 'IndexOnlineRebuild'
ELSE 
	SET @online_allowed = 0
	

IF OBJECT_ID('tempdb..#partitions') is not null
	DROP TABLE #partitions

CREATE TABLE #partitions
(
	database_id int, 
	schema_id int,  
	object_id int, 
	object_name nvarchar(4000),
	index_id int,
	index_name nvarchar(4000),
	volume_mount_point nvarchar(255),
	allow_page_locks bit,
	legacy_col_count int,
	xml_col_count int,
	user_scans bigint,
	partition_count int,
	partition_number int,
	row_count bigint,
	size_mb decimal(10,3),
	avg_fragmentation_in_percent decimal(10,3)
)

INSERT INTO #partitions
SELECT 
database_id,
schema_id,
object_id,
object_name,
index_id,
index_name,
volume_mount_point,
allow_page_locks,
legacy_col_count,
xml_col_count,
user_scans,
partition_count,
partition_number,
row_count,
size_mb,
avg_fragmentation_in_percent
FROM
[dbo].[FragmentationData] with (FORCESEEK)
WHERE
(entry_id = @entry_id
OR
(@entry_id is NULL and 
database_id = @db
and analysis_status = 1))
AND avg_fragmentation_in_percent > @frag_threshold



INSERT dbo.Tasks (
	batch_id
	,subsystem_id
	,action_type_id
	,command
	,date_added
	,[database_id]
	,table_id
	,index_id
	,partition_n
	,[maxdop]
	,ix_frag
	,user_seeks
	,user_scans
	,user_updates
	,rowcnt
	,size_mb
	,[priority]
	,volume_mount_point
)
SELECT
	@batch,
	1,  --index maintenance
	t.action_type_id,
	t.command,
	getdate(),
	@db,
	t.object_id,
	t.index_id,
	t.partition_number,
	t.maxdop,
	t.avg_fragmentation_in_percent,
	NULL, --removed seeks - useless
	t.user_scans,
	NULL, --removed updates
	t.row_count,
	t.size_mb,
	CASE WHEN ISNULL(pt.exit_code,1) <> 1 THEN 2 ELSE 1 END --Если предыдущий таск завершился с ошибкой понижаем этму приоритет
	,t.volume_mount_point
FROM
	(
		SELECT
			CASE 
				WHEN t.action = N'REBUILD' AND t.online LIKE N'OFF%' THEN 1
				WHEN t.action = N'REBUILD' AND t.online is null THEN 1
				WHEN t.action = N'REBUILD' AND t.online LIKE N'ON%' THEN 2
				WHEN t.action = N'REORGANIZE' THEN 3
			END as action_type_id,
			--Конструирую выражение / Assembling statement
			N'USE ' + QUOTENAME(DB_NAME(@db)) + N'; ' +
			CASE WHEN @locktimeout<60000 or (@@MicrosoftVersion/0x01000000)<12 THEN N'SET LOCK_TIMEOUT ' + t.lock_timeout + N'; ' ELSE '' END +
			N'ALTER INDEX [' + t.index_name + N'] ON '+ t.object_name + N' ' + t.action + N' ' + t.partition_spec +
			CASE WHEN t.action = N'REBUILD' THEN N'WITH ('+COALESCE('ONLINE='+ t.online,'') +N'SORT_IN_TEMPDB='+ t.sort_in_tempdb + N'MAXDOP='+ t.maxdop + N')' ELSE N'' END + N';' --rebuild options
			as command,
			*
		FROM
			(	--Подготавливаю опции / prepare options for the statement
				SELECT 
					--REORG or REBUILD:
					CASE WHEN avg_fragmentation_in_percent > @reorg_threshold THEN N'REBUILD' ELSE N'REORGANIZE' END as [action],
					--If we have multiple partitions, specify the partition number
					CASE WHEN partition_count > 1 THEN N' PARTITION = ' + CAST(partition_number as nvarchar(10)) ELSE N'' END + N' ' as partition_spec,
					--Sort in tempdb determined by global option
					CASE WHEN @sortintempdb = 1 THEN N'ON, ' ELSE N'OFF, ' END [sort_in_tempdb],
					--If possible, perform online rebuild
					CASE 
						WHEN @online_allowed = 0 THEN N'OFF, /*disabled*/ '  --online is disabled in settings
						WHEN legacy_col_count > 0 THEN N'OFF, /*legacy*/ ' --legacy column types can't be rebuilt online
						WHEN xml_col_count > 0 AND (@@MicrosoftVersion/0x01000000)<11 THEN N'OFF, /*xml*/ ' --xml columns can't be rebuild online prior to 2012
						--WHEN partition_count = 1 THEN NULL --one partition can't be rebuild online and even OFF is incorrect
						WHEN partition_count > 1 AND (@@MicrosoftVersion/0x01000000)<12 THEN NULL --prior to SQL 2014 partitions could not be rebuilt online and even OFF is incorrect
						ELSE --We can use online rebuild
							CASE 
							--Starting from 2014 rebuild can wait at low priority:
								WHEN (@@MicrosoftVersion/0x01000000)>=12 and @locktimeout >= 60000 /*more than a minute */ THEN N'ON (WAIT_AT_LOW_PRIORITY ( MAX_DURATION = '+cast(@locktimeout/60000 as nvarchar(20))+' , ABORT_AFTER_WAIT = SELF ) ),' 
								
								ELSE N'ON, ' --Simply online
								
								
							END

					END as [online],
					--Lock timeout from global settings
					CAST(@locktimeout as nvarchar(10)) as [lock_timeout],
					--Set maxdop if page locks are not prohibited. See  http://support.microsoft.com/kb/2292737 
					CASE 
						WHEN [allow_page_locks] = 1 OR (@@MicrosoftVersion/0x01000000)>=11  THEN  CAST(ISNULL(@maxdop,1) AS nvarchar(10))
						--WHEN @allow_pl = 0 AND (@@MicrosoftVersion/0x01000000)<11 THEN N'1' 
						ELSE N'1'
					END as [maxdop],
					*
				FROM 
					#partitions p
			) t
	) t
	OUTER APPLY --находим такой же предыдущий таск / Find similar prevous task 
	(
		SELECT TOP 1 pt.exit_code 
		FROM
			dbo.Tasks pt
		WHERE
			pt.subsystem_id = 1 
			AND pt.action_type_id = t.action_type_id
			AND pt.database_id = t.database_id
			AND pt.table_id = t.object_id
			AND pt.index_id = t.index_id
			AND pt.partition_n = t.partition_number
			AND pt.date_completed is not null
		ORDER BY
			pt.date_completed DESC
	) pt
WHERE
	--Фрагментация выше порога / Fragmentation above threshold
	NOT EXISTS	(
		SELECT 1 
		FROM dbo.Blacklist bl
		WHERE 
			bl.[database_id] = @db 
			AND (bl.table_id = t.object_id or bl.table_id is null)
			AND (bl.index_id = t.index_id or bl.index_id is null) 
			AND (bl.subsystem_id = 1 or bl.subsystem_id is null)
			AND (bl.action_type_id = t.action_type_id or bl.action_type_id is null)
			AND (bl.partition_n = t.partition_number or bl.partition_n is null)
			AND (bl.worker_name = @worker_name or worker_name is null)
			AND bl.enabled = 1
	)
ORDER BY 
	t.user_scans DESC,
	t.avg_fragmentation_in_percent DESC,
	t.size_mb DESC]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[decimal]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[@maxdop]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[@sortintempdb]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[schema_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[object_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[index_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[volume_mount_point]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[allow_page_locks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[legacy_col_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[xml_col_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[user_scans]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[partition_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[row_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[avg_fragmentation_in_percent]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[@entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[analysis_status]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[command]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[maxdop]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[ix_frag]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[user_seeks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[user_scans]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[user_updates]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[rowcnt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[priority]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[volume_mount_point]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[avg_fragmentation_in_percent]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[partition_count]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[legacy_col_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[xml_col_count]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[allow_page_locks]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[index_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[object_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[@batch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[avg_fragmentation_in_percent]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[user_scans]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[row_count]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[volume_mount_point]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueIndex_async].[#partitions].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Blacklist].[enabled]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[FillQueueIndex_async].[#partitions]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[database_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[schema_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[object_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[object_name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="4000" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[index_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[index_name]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="4000" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[volume_mount_point]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Length" Value="255" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[nvarchar]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[allow_page_locks]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bit]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[legacy_col_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[xml_col_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[user_scans]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bigint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[partition_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[partition_number]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[row_count]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[bigint]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[size_mb]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Scale" Value="3" />
												<Property Name="Precision" Value="10" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[decimal]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[FillQueueIndex_async].[#partitions].[avg_fragmentation_in_percent]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Property Name="Scale" Value="3" />
												<Property Name="Precision" Value="10" />
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[decimal]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex_async].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex_async].[@batch]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex_async].[@maxdop]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex_async].[@sortintempdb]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueIndex_async].[@entry_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="1113" />
				<Property Name="Length" Value="8484" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: &#xD;&#xA;Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;Arseny Birukov arsbir@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;&#xD;&#xA;Процедура формирования заданий обслуживания индексов на основе их состояния. &#xD;&#xA;Задания - выражения для обслуживания отдельных индексов - добавляются в таблицу dbo.Tasks&#xD;&#xA;Применяется оценка процента фрагментации и возможности перестройки индекса онлайн.&#xD;&#xA;Для приоритезации заданий используется частота обращений к индексу (только user_scan), фрагментация и размер индекса.  &#xD;&#xA;&#xD;&#xA;English:&#xD;&#xA;&#xD;&#xA;Stored procedure creates tasks for index maintenance based on their state and operational stats.&#xD;&#xA;Tasks are T-SQL statements of index REBUILD/REORGANIZE, that are inserted in dbo.Tasks table.&#xD;&#xA;Index is evaluated by frag percent, user scans counter and size. &#xD;&#xA;First goes the most used (user scans) index with higher fragmentation and the larger size.   &#xD;&#xA;&#xD;&#xA; &#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[FillQueueIndex_async] &#xD;&#xA;&#x9; @db INT&#xD;&#xA;&#x9;,@batch UNIQUEIDENTIFIER&#xD;&#xA;&#x9;,@maxdop INT = NULL&#xD;&#xA;&#x9;,@sortintempdb BIT = NULL&#xD;&#xA;&#x9;,@entry_id bigint = NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[FillQueueStat]">
			<Property Name="BodyScript">
				<Value><![CDATA[
DECLARE	@SQL NVARCHAR(MAX)
	,@tableid INT
	,@indexid INT
	,@partitionnum INT
	,@subsystem_id INT
	,@actiontype INT
	,@entryid BIGINT

IF @batch is null
SET @batch = newid()

IF @sample not like N'SAMPLE % ROWS' AND @sample not like N'FULLSCAN' AND @sample not like N'RESAMPLE' AND @sample not like N'SAMPLE % PERCENT'
BEGIN SET @sample = N'RESAMPLE' --@sample parameter control. 
PRINT N'Warning! Incorrect sample selected! Using RESAMPLE!'
END



DELETE --delete old tasks, because they are now useless.
FROM dbo.Tasks
WHERE subsystem_id = 2 --Подсистема обслуживания статистики / Statistics management subsystem_id tasks
	AND date_completed IS NULL
	AND [database_id] = @db
	AND [worker_name] IS NULL

SET @SQL = '
DECLARE @worker_name nvarchar(255)
SELECT @worker_name = worker_name
FROM VBMS.dbo.WorkerSessions
WHERE session_id = @@SPID

USE [' + db_name(@db) + '];
 INSERT VBMS.dbo.Tasks (
 batch_id
 ,subsystem_id
 ,action_type_id
 ,command
 ,date_added
 ,database_id
 ,table_id
 ,index_id
 ,size_mb
 ,rowcnt
 ,rowmod_factor)
 (
SELECT DISTINCT
''' + CAST(@batch AS NVARCHAR(50)) + '''
	,2
	,1
	,''USE [' + DB_NAME(@db) + 
	']
	UPDATE STATISTICS ['' + SCHEMA_NAME(so.schema_id) + ''].['' + OBJECT_NAME(so.object_id) +''] [''+ISNULL(s.name, '''') + ''] WITH '+@sample+''' AS command
	,getdate()
	,db_id()
	,so.object_id
	,s.stats_id
	,SUM(CAST(ps.used_page_count * 8 / 1024.00 AS DECIMAL(10, 3))) AS size_mb
	,ssi2.rows
	,CASE 
		WHEN ssi2.rows < 25000
			THEN (((ssi.rowmodctr + 0.0001) / (ssi2.rows + 0.000001)) * 100.00 - (ssi2.rows * 0.2 + 500) / (ssi2.rows +0.000001) * 100)
		ELSE (((ssi.rowmodctr + 0.0001) / (ssi2.rows + 0.000001)) * 100.00 - sqrt((ssi2.rows) * 1000.00) / (ssi2.rows + 0.000001) * 100.00)
		END as rowmod_factor
FROM sys.stats  s (NOLOCK)
join sys.dm_db_partition_stats ps (NOLOCK)  on s.object_id = ps.object_id and ps.index_id < 2
join sys.sysindexes ssi (NOLOCK)  on s.object_id = ssi.id and ssi.indid = s.stats_id
join sys.objects so (NOLOCK)  on so.object_id = s.object_id
AND so.type IN (
		N''U''
		,N''V''
		)
join sys.sysindexes ssi2 on s.object_id = ssi2.id and ssi2.indid < 2
join sys.indexes si  on s.object_id = si.object_id and si.index_id = s.stats_id and si.type in (1,2)
WHERE so.is_ms_shipped = 0
	AND
	(ssi2.rows > 500)
		AND ssi.rowmodctr > (
			CASE 
				WHEN (ssi2.rows < 25000)
					THEN (sqrt((ssi2.rows) * 1000))
				WHEN ((ssi2.rows) > 25000)
					THEN ((ssi2.rows) * 0.2 + 500)
				END
			)
--Blacklisting
AND not exists
(SELECT 1 
FROM VBMS.dbo.Blacklist bl
WHERE 
 (bl.database_id = db_id() 
 and (bl.table_id = so.object_id or bl.table_id is null))
 and (bl.index_id = s.stats_id or bl.index_id is null) 
and (bl.subsystem_id = 2 or bl.subsystem_id is null)
AND (bl.worker_name = @worker_name or worker_name is null)
and bl.enabled = 1
)
--Blacklisting
GROUP BY so.schema_id
	,so.object_id
	,s.stats_id
	,s.name
	,ssi.rowmodctr 
	,ssi2.rows
	
	
)'

EXEC(@SQL)


DECLARE TASKS CURSOR
FOR SELECT entry_id, table_id,index_id,partition_n,subsystem_id, action_type_id
FROM dbo.Tasks WHERE time_prognosis_s is null
and database_id = @db
and batch_id = @batch


OPEN TASKS

FETCH NEXT FROM TASKS
INTO @entryid,@tableid,@indexid,@partitionnum,@subsystem_id,@actiontype

WHILE @@FETCH_STATUS = 0 
BEGIN 

UPDATE dbo.Tasks
SET time_prognosis_s = ISNULL(dbo.GetTimeFactor(@db,1,@tableid,@indexid,@partitionnum,@subsystem_id, @actiontype,60,1),0) * size_mb
WHERE entry_id = @entryid
FETCH NEXT FROM TASKS
INTO @entryid,@tableid,@indexid,@partitionnum,@subsystem_id,@actiontype


END

CLOSE TASKS
DEALLOCATE TASKS]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueStat].[@batch]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueStat].[@sample]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueStat].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[worker_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[time_prognosis_s]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueStat].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueStat].[@batch]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[FillQueueStat].[@sample]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA['FULLSCAN']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="1034" />
				<Property Name="Length" Value="4848" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Version 2.0.2.5&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;Процедура добавления заданий пересчёта статистики в таблицу dbo.Tasks&#xD;&#xA;При оценке актуальности статистики используется динамический порог,&#xD;&#xA;работающий аналогично флагу трассировки 2371. Автор формулы Juergen Thomas.&#xD;&#xA;Для приоретизации используется процент превышения порога перерасчёта статистики (поле rowmod_factor)&#xD;&#xA;&#xD;&#xA;English:&#xD;&#xA;&#xD;&#xA;Stored procedure creates tasks for statistics update in table dbo.Tasks.&#xD;&#xA;Each task is a T-SQL Statement UPDATE STATISTICS(&lt;Table name&gt;) WITH FULLSCAN.&#xD;&#xA;Dynamic threshold formula like in traceflag 2371 is used.&#xD;&#xA;Formula is created by Juergen Thomas.&#xD;&#xA;Tasks are sorted by rowmod_factor that is computed like a percent of threshold deviation.&#xD;&#xA;Greater is worse.&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;CREATE PROCEDURE [dbo].[FillQueueStat] @db INT ,@batch UNIQUEIDENTIFIER = null, @sample nvarchar(50) = 'FULLSCAN'&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[dbo].[FK_Tasks_OperationTypes]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[dbo].[OperationTypes].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[OperationTypes].[action_type_id]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[dbo].[OperationTypes]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="44" />
		</Element>
		<Element Type="SqlForeignKeyConstraint" Name="[dbo].[FK_WorkerSession_Workers]">
			<Relationship Name="Columns">
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignColumns">
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForeignTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="45" />
		</Element>
		<Element Type="SqlView" Name="[dbo].[FragAnalysisStatus]">
			<Property Name="QueryScript">
				<Value><![CDATA[
	select 
       batch_id,
       MAX(collection_date) as MaxDateAdded,
       MIN(analysis_started) as FirstAnalysisStarted,
       CASE WHEN analysis_status = 0 then NULL ELSE  max(analysis_completed) END as RecentAnalysisCompleted, 
       ISNULL(DATEDIFF(SECOND,MIN(analysis_started),COALESCE(MAX(analysis_completed),getdate())),0) as Duration,
       CASE analysis_status       
             WHEN 0 THEN 'Scheduled' 
             WHEN 1 THEN 'Analized' 
             WHEN 2 THEN 'Completed'
             ELSE 'Error' END as [Status],
       exit_code,
       count(*) as [TasksCount],
       SUM(size_mb) as SizeMB,
       SUM(size_mb)*100.00/SUM(SUM(size_mb)) over (PARTITION BY batch_id) as [SizePercentTotal]
       ,COUNT(*)*100.00/SUM(count(*)) over(PARTITION BY batch_id) as [CountPercentTotal]
  
  FROM [dbo].[FragmentationData]
  GROUP BY batch_id,analysis_status,exit_code]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[batch_id]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[dbo].[FragmentationData].[batch_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[MaxDateAdded]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[FirstAnalysisStarted]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[RecentAnalysisCompleted]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[Duration]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[Status]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[exit_code]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[dbo].[FragmentationData].[exit_code]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[TasksCount]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[SizeMB]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[SizePercentTotal]" />
				</Entry>
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[FragAnalysisStatus].[CountPercentTotal]" />
				</Entry>
			</Relationship>
			<Relationship Name="QueryDependencies">
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[batch_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[collection_date]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[analysis_started]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[analysis_status]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[analysis_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[size_mb]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="949" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE VIEW [dbo].[FragAnalysisStatus]&#xD;&#xA;&#x9;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[FragmentationData]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[entry_id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[batch_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[collection_date]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[database_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[schema_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[object_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[object_name]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="517" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[index_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[index_name]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[sys].[sysname]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[allow_page_locks]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[legacy_col_count]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[xml_col_count]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[user_scans]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[partition_count]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[partition_number]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[row_count]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[size_mb]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="3" />
									<Property Name="Precision" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[avg_fragmentation_in_percent]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="3" />
									<Property Name="Precision" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[analysis_started]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[analysis_completed]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[analysis_spid]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[analysis_duration_ms]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[analysis_status]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[analysis_time_prognosis_ms]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[exit_code]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[exit_message]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="4000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[analysis_batch_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[time_factor]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Precision" Value="53" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[float]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FragmentationData].[volume_mount_point]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="46" />
		</Element>
		<Element Type="SqlIndex" Name="[dbo].[FragmentationData].[IX_FragData_dbid_frag_spid_userscans]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[database_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[avg_fragmentation_in_percent]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[analysis_spid]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[user_scans]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="IncludedColumns">
				<Entry>
					<References Name="[dbo].[FragmentationData].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[size_mb]" />
				</Entry>
			</Relationship>
			<Relationship Name="IndexedObject">
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlIndex" Name="[dbo].[FragmentationData].[IX_FragData_dbid_objid_indexid_part_start_completed_code]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[database_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[object_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[index_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[partition_number]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[analysis_started]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[analysis_completed]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[exit_code]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="IndexedObject">
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlIndex" Name="[dbo].[FragmentationData].[IX_FragData_Status_entry_databaseid]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[analysis_status]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[entry_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[database_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[avg_fragmentation_in_percent]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="IndexedObject">
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[GetAGSyncState]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[GetAGSyncState].[@dbint_id]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry>
					<References Name="[dbo].[GetAGSyncState].[@ag_max_queue]" />
				</Entry>
				<Entry />
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
BEGIN
DECLARE @result bit = 0
select top 1 @result = 1 from sys.dm_hadr_database_replica_states
where database_id = @dbint_id
and is_local = 0
and (synchronization_health <> 2
or log_send_queue_size > @ag_max_queue
or redo_queue_size > @ag_max_queue)
RETURN @result
END]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="377" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION dbo.GetAGSyncState&#xD;&#xA;(&#xD;&#xA;@dbint_id int&#xD;&#xA;,@ag_max_queue bigint&#xD;&#xA;)&#xD;&#xA;&#xD;&#xA;RETURNS BIT&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetAGSyncState].[@dbint_id]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetAGSyncState].[@ag_max_queue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[bit]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[GetDBBackupState]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_requests]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_requests].[command]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_requests].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDBBackupState].[@dbint_id]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
BEGIN
	DECLARE @result bit = 0
	select top 1 @result = 1 from sys.dm_exec_requests 
	where command like 'BACKUP DATABASE%' and database_id = @dbint_id
	RETURN @result
END]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="256" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION [dbo].[GetDBBackupState]&#xD;&#xA;(&#xD;&#xA;&#x9;@dbint_id int&#xD;&#xA;)&#xD;&#xA;RETURNS bit&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetDBBackupState].[@dbint_id]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[bit]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlInlineTableValuedFunction" Name="[dbo].[GetDbList]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[databases]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[databases].[database_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[databases].[is_read_only]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[databases].[state]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDbList].[@use_system_db]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[databases].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDbList].[@use_user_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDbList].[@dbname_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDbList].[@except_list]" />
				</Entry>
			</Relationship>
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[GetDbList].[database_id]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References ExternalSource="master.dacpac" Name="[master]|[sys].[databases].[database_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[ 	
SELECT database_id 
FROM sys.databases 
WHERE 
	is_read_only = 0 
	AND [state] = 0 
	AND ( 
		(@use_system_db=1 and name in ('master','msdb','VBMS')) 
		or 
		(@use_user_db=1 and name not in ('master','msdb','model','tempdb','VBMS')) 
	)
	AND (
		@dbname_list='' 
		or 
		(@except_list=0 and ','+@dbname_list+',' like '%,'+name+',%') 
		or 
		(@except_list=1 and ','+@dbname_list+',' not like '%,'+name+',%') 
	)]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="590" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION [dbo].[GetDbList]&#xD;&#xA;(&#xD;&#xA;&#x9;@use_system_db bit,&#xD;&#xA;&#x9;@use_user_db bit,&#xD;&#xA;&#x9;@dbname_list varchar(500),&#xD;&#xA;&#x9;@except_list bit&#xD;&#xA;)&#xD;&#xA;&#xD;&#xA;RETURNS TABLE&#xD;&#xA;AS&#xD;&#xA;RETURN" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetDbList].[@use_system_db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetDbList].[@use_user_db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetDbList].[@dbname_list]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetDbList].[@except_list]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[GetTimeFactor]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[float]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[float]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[float]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@execution]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[time_factor]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@tableid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@indexid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@partitionnum]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@days_past]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor].[@normalize]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[time_factor]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[object_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[partition_number]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[analysis_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FragmentationData].[exit_code]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
BEGIN
	DECLARE 
		@RESULT FLOAT
		,@avg FLOAT
		,@dev FLOAT

IF @execution = 1
BEGIN
	
	SELECT 
		@avg = avg(time_factor)
		,@dev = stdev(time_factor)
	FROM [dbo].[Tasks] (NOLOCK)
	WHERE [database_id] = @db
		AND ((table_id is null and @tableid is null) or (table_id = @tableid))
		AND ((index_id is null and @indexid is null) or (index_id = @indexid))
		AND ((partition_n is null and @partitionnum is null) or (partition_n = partition_n))
		AND subsystem_id = @subsystem_id
		AND [action_type_id] = @action_type_id
		AND datediff(dd, date_completed, getdate()) < @days_past
		AND time_factor IS NOT NULL
		AND exit_code = 1
		and size_mb > 0
	
	IF @normalize = 1 AND @dev IS NOT NULL
	BEGIN
		SELECT @RESULT = AVG(time_factor)
		FROM [dbo].[Tasks] (NOLOCK)
		WHERE [database_id] = @db
			AND ((table_id is null and @tableid is null) or (table_id = @tableid))
			AND ((index_id is null and @indexid is null) or (index_id = @indexid))
			AND ((partition_n is null and @partitionnum is null) or (partition_n = partition_n))
			AND subsystem_id = @subsystem_id
			AND [action_type_id] = @action_type_id
			AND time_factor BETWEEN @avg - @dev
				AND @avg + @dev
			AND  date_completed > DATEADD(dd,-1*@days_past,getdate())
			AND time_factor IS NOT NULL
			AND exit_code = 1
			and size_mb > 0

		


	END
	ELSE
	BEGIN
		SET @RESULT = @avg
	END
	--If no data available then try to use history of other tasks
	IF @RESULT is NULL --try find data for another partition
			SELECT @RESULT = AVG(time_factor)
			FROM [dbo].[Tasks] (NOLOCK)
			WHERE [database_id] = @db
			AND ((table_id is null and @tableid is null) or (table_id = @tableid))
			AND ((index_id is null and @indexid is null) or (index_id = @indexid))
			--AND ((partition_n is null and @partitionnum is null) or (partition_n = partition_n))
			AND subsystem_id = @subsystem_id
			AND [action_type_id] = @action_type_id
			
			AND  date_completed > DATEADD(dd,-1*@days_past,getdate())
			AND time_factor IS NOT NULL
			AND exit_code = 1
			and size_mb > 0
			
			IF @RESULT is NULL --if still nothing try another index on same table
				SELECT @RESULT = AVG(time_factor)
			FROM [dbo].[Tasks] (NOLOCK)
			WHERE [database_id] = @db
			AND ((table_id is null and @tableid is null) or (table_id = @tableid))
			--AND ((index_id is null and @indexid is null) or (index_id = @indexid))
			--AND ((partition_n is null and @partitionnum is null) or (partition_n = partition_n))
			AND subsystem_id = @subsystem_id
			AND [action_type_id] = @action_type_id
			
			AND  date_completed > DATEADD(dd,-1*@days_past,getdate())
			AND time_factor IS NOT NULL
			AND exit_code = 1
			and size_mb > 0
					
					IF @RESULT is NULL --If still nothing try another table
						SELECT @RESULT = AVG(time_factor)
							FROM [dbo].[Tasks] (NOLOCK)
							WHERE [database_id] = @db
							--AND ((table_id is null and @tableid is null) or (table_id = @tableid))
							--AND ((index_id is null and @indexid is null) or (index_id = @indexid))
							--AND ((partition_n is null and @partitionnum is null) or (partition_n = partition_n))
							AND subsystem_id = @subsystem_id
							AND [action_type_id] = @action_type_id
							
							AND  date_completed > DATEADD(dd,-1*@days_past,getdate())
							AND time_factor IS NOT NULL
							AND exit_code = 1
							and size_mb > 0

							IF @RESULT is NULL --may be other database?
						SELECT @RESULT = AVG(time_factor)
							FROM [dbo].[Tasks] (NOLOCK)
							WHERE
							--[database_id] = @db
							--AND ((table_id is null and @tableid is null) or (table_id = @tableid))
							--AND ((index_id is null and @indexid is null) or (index_id = @indexid))
							--AND ((partition_n is null and @partitionnum is null) or (partition_n = partition_n))
							subsystem_id = @subsystem_id
							AND [action_type_id] = @action_type_id
							AND  date_completed > DATEADD(dd,-1*@days_past,getdate())
							AND time_factor IS NOT NULL
							AND exit_code = 1
							and size_mb > 0

					IF @RESULT is NULL --well, if nothing is available, then we'll use basic values for this kind of operations. cross your fingers...
						SET @RESULT = CASE @subsystem_id 
										WHEN  1 then 0.05 
										WHEN 2 THEN 0.05 
										WHEN 3 THEN CASE @action_type_id 
													WHEN 1 then 0.025
													when 2 then 0.05 
													when 3 then 0.05 
													end 
										end 	
END

ELSE --If we deal with fragmentation data and not the execution statistics
	BEGIN
	SELECT 
				@avg = avg(time_factor)
				,@dev = stdev(time_factor)
			FROM [dbo].[FragmentationData] (NOLOCK)
			WHERE [database_id] = @db
				AND (object_id = @tableid)
				AND (index_id = @indexid)
				AND (partition_number = @partitionnum)
				
				AND analysis_completed > DATEADD(dd,-1*@days_past,GETDATE())
				AND time_factor IS NOT NULL
				AND exit_code = 1
	
			IF @normalize = 1 AND @dev IS NOT NULL
			BEGIN
				SELECT @RESULT = AVG(time_factor)
				FROM [dbo].[FragmentationData] (NOLOCK)
				WHERE [database_id] = @db
					AND (object_id = @tableid)
				AND (index_id = @indexid)
				AND (partition_number = @partitionnum)
					AND time_factor BETWEEN @avg - @dev
						AND @avg + @dev
					AND analysis_completed > DATEADD(dd,-1*@days_past,GETDATE())
					AND time_factor IS NOT NULL
					AND exit_code = 1

					END
	ELSE
	BEGIN
		SET @RESULT = @avg
	END

	
	END
RETURN @RESULT
END]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="CreateOffset" Value="550" />
							<Property Name="Length" Value="6367" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="&#xD;&#xA;/*&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;&#xD;&#xA;Скалярная функция получения величины time factor, которая используется для предсказания времени выполнения заданий. &#xD;&#xA;Используется статистика ранее выполненных заданий. Для отсечки девиаций используется 2-сигма окрестность.&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE FUNCTION [dbo].[GetTimeFactor] (&#xD;&#xA;&#x9;@db INT&#xD;&#xA;&#x9;,@execution bit --  1 - tasks execution or 0 - index fragmentation evaluation&#xD;&#xA;&#x9;,@tableid INT&#xD;&#xA;&#x9;,@indexid INT&#xD;&#xA;&#x9;,@partitionnum INT&#xD;&#xA;&#x9;,@subsystem_id INT = 1&#xD;&#xA;&#x9;,@action_type_id INT =1&#xD;&#xA;&#x9;,@days_past INT = 60&#xD;&#xA;&#x9;,@normalize INT = 1&#xD;&#xA;&#x9;)&#xD;&#xA;RETURNS FLOAT&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@db]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@execution]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@tableid]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@indexid]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@partitionnum]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@subsystem_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@action_type_id]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@days_past]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[60]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetTimeFactor].[@normalize]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Property Name="Precision" Value="53" />
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[float]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[KillWorkers]">
			<Property Name="BodyScript">
				<Value><![CDATA[

DECLARE @spid INT
DECLARE @sql NVARCHAR(500) = ''
DECLARE @subsystem_id INT
DECLARE @entry_id bigint
DECLARE @victim nvarchar(50)

DECLARE workers CURSOR FORWARD_ONLY
	FOR SELECT worker_name, session_id, subsystem_id, entry_id from dbo.[WorkerSessions] 
	WHERE 
 (
      @worker_names='' 
      or 
      (@except_list=0 and ','+@worker_names+',' like '%,'+worker_name+',%') 
      or 
      (@except_list=1 and ','+@worker_names+',' not like '%,'+worker_name+',%') 
)

WHILE EXISTS (
SELECT 1 FROM dbo.[WorkerSessions] 
	WHERE 
 (
      @worker_names='' 
      or 
      (@except_list=0 and ','+@worker_names+',' like '%,'+worker_name+',%') 
      or 
      (@except_list=1 and ','+@worker_names+',' not like '%,'+worker_name+',%') 
)

)
BEGIN

DELETE FROM dbo.[WorkerSessions]
WHERE not exists(
	select 1 from sys.dm_exec_sessions es 
		where es.session_id = dbo.[WorkerSessions].session_id 
		and es.program_name COLLATE DATABASE_DEFAULT = dbo.[WorkerSessions].program_name COLLATE DATABASE_DEFAULT)

	
OPEN workers

FETCH NEXT FROM workers
INTO @victim, @spid,@subsystem_id, @entry_id

WHILE @@FETCH_STATUS = 0 
BEGIN
IF (@subsystem_id <> 1 or @force = 1)
	BEGIN
	SET @sql = 'KILL ' + cast(@spid AS NVARCHAR(10)) + '
			UPDATE dbo.Tasks SET result = ''Killed'',exit_code = 0, date_completed = getdate() WHERE entry_id = '+cast(@entry_id as nvarchar(10))+' 
			UPDATE dbo.Workers SET stoplight = 0 where worker_name = ''' + CAST(@victim AS NVARCHAR(36)) + ''' and stoplight <> 0
			DELETE FROM dbo.WorkerSessions where worker_name = ''' + CAST(@victim AS NVARCHAR(36)) + ''''

			EXEC (@sql)
			PRINT 'Worker ''' + CAST(@victim AS NVARCHAR(36)) + ''' has been killed at step' + cast(@subsystem_id AS NVARCHAR(5)) + ' at ' + CAST(GETDATE() as NVARCHAR(30)) + '. R.I.P. Bro...'
	END
ELSE
BEGIN
UPDATE dbo.Workers 
SET stoplight = -1
WHERE worker_name = @victim
AND stoplight = 0
END
FETCH NEXT FROM workers
INTO @victim, @spid,@subsystem_id, @entry_id

END

CLOSE workers
WAITFOR DELAY '00:00:05'
END

DEALLOCATE workers]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[KillWorkers].[@worker_names]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[KillWorkers].[@except_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[program_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[program_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[KillWorkers].[@force]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stoplight]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[KillWorkers].[@worker_names]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA['']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[KillWorkers].[@except_list]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[KillWorkers].[@force]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="1060" />
				<Property Name="Length" Value="3269" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;Процедура прерывания процессов обработки очереди заданий (Worker). &#xD;&#xA;Процедура может принимать в качестве входного параметра список имен профилей через запятую без пробелов.&#xD;&#xA;Если Worker обнаружен в состоянии выполения заданий обслуживания индексов, то прерывания не происходит,&#xD;&#xA; выполняется ожидание завершения этого процесса.&#xD;&#xA;Это сделано с целью избежания отката операции с индексом, который может потребовать даже больше времени.  &#xD;&#xA;Эта проверка отменяется параметром @force.&#xD;&#xA;&#xD;&#xA;English:&#xD;&#xA;Procedure designed to kill one or several Workers (names supplied as a list without spaces). &#xD;&#xA;If worker is found performing index operations then&#xD;&#xA;procedure waits, to avoid rollback. If @force = 1, then worker is killed immediately.&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[KillWorkers] (@worker_names nvarchar(500) = '', @except_list bit = 0, @force bit = 0)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[OperationTypes]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[OperationTypes].[subsystem_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[OperationTypes].[action_type_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[OperationTypes].[subsystem_name]">
						<Property Name="Collation" Value="Cyrillic_General_CI_AS" />
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[OperationTypes].[action_type_name]">
						<Property Name="Collation" Value="Cyrillic_General_CI_AS" />
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="47" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Parameters]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Parameters].[parameter]">
						<Property Name="Collation" Value="Cyrillic_General_CI_AS" />
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Parameters].[string_value]">
						<Property Name="Collation" Value="Cyrillic_General_CI_AS" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="150" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Parameters].[int_value]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Parameters].[float_value]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Precision" Value="53" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[float]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Parameters].[description]">
						<Property Name="Collation" Value="Cyrillic_General_CI_AS" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_FragmentationData]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[FragmentationData].[entry_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FragmentationData]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="46" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_OperationTypes]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[OperationTypes].[subsystem_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[OperationTypes].[action_type_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[OperationTypes]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="47" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_TasksHistory]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[entry_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="48" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_Workers]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Workers].[worker_name]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="49" />
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[ProcessQueueAll]">
			<Property Name="BodyScript">
				<Value><![CDATA[

SET NOCOUNT ON

DECLARE 
	@command NVARCHAR(max) --выполняемое выражение / command to execute
	,@entry_id INT
	,@subsystem_id INT = 1 --Индексы обслуживаются первыми / Index maintenance first
	,@t1 DATETIME --две переменных @t1 и @t2 нужны для промежуточных расчётов времени / vars for time tracking
	,@finish_time datetime
	,@action_type_id INT
	,@size_mb INT
	,@timefactor FLOAT
	,@table_id INT
	,@index_id INT
	,@partition_number INT
	,@msg NVARCHAR(max)
	,@retention datetime
	,@db int
	,@deadlock_flag bit
	,@exit_code INT
	,@stoplight BIT
	,@log_space BIT
	,@log_space_threshold_mb bigint
	,@error_count int = 0 
	,@null_flag bit = 0
	,@db_backup bit = 0
	,@ag_state bit = 0

	
--Обработка заданий по БД, которых уже нет / Handeling tasks for non-existent DB's

UPDATE dbo.Tasks
SET 
	result = 'DB not found'
	,date_started = date_added
	,date_completed = date_added
where 
	date_completed is null
	AND DB_NAME([database_id]) is null


--Removing the stoplight if it is set somehow.
UPDATE dbo.Workers
SET stoplight = 0
WHERE 
	worker_name = @worker_name
	AND stoplight <> 0

--Row in WorkerSessions might remain from terminated execution
DELETE FROM dbo.[WorkerSessions] 
WHERE worker_name = @worker_name AND session_id = @@SPID

INSERT dbo.[WorkerSessions] (worker_name,session_id, program_name)
select @worker_name,@@SPID, program_name from sys.dm_exec_sessions where session_id=@@SPID

--Инициализация параметров / Loading parameters
IF (@index_time is not null or @stat_time is not null or @check_time is not null)
	BEGIN
	SET @null_flag = 1
	END

IF @total_time is null
BEGIN
	SELECT @total_time = int_value * 60 --перевод из минут в миллисекунды / from minutes to milliseconds
	FROM dbo.Parameters
	WHERE parameter = 'TotalMaintenanceWindowMm' --общее время на обслуживание / Total maintenace time
END
ELSE
	BEGIN
	SET @total_time = @total_time * 60
	END

--Print 'Total time:'
--Print @total_time

IF @index_time is null and @null_flag = 0
BEGIN
	SELECT @index_time = @total_time * int_value / 100
	FROM --расчёт значений в миллисекундах, параметры хранятся в процентах от общего времени. / From percents of total time to milliseconds.
	dbo.Parameters
	WHERE parameter = 'IndexMaintenanceWindowPercent' --время, отведённое на обслуживание индексов. Параметр хранится в процентах от общего времени./ Index maintenance time. Stored as percents of total maintenance time
END
ELSE IF @index_time is null and @null_flag = 1
	SET @index_time = 0
ELSE
	SET @index_time = @total_time * @index_time / 100


--Print 'Index time'
--Print @index_time

IF @check_time is null and @null_flag = 0
BEGIN
	SELECT @check_time = @total_time * int_value / 100
	FROM dbo.Parameters
	WHERE parameter = 'CheckWindowPercent' --время, отведённое на проверку целостности. Параметр хранится в процентах от общего времени. / Integrity checks time. Stored as percents of total maintenance time
END
ELSE IF
	@check_time is null and @null_flag = 1
	SET @check_time = 0
ELSE 
	SET @check_time = @total_time * @check_time / 100


--Print 'Check Time'
--Print @check_time

IF @stat_time is null and @null_flag = 0
BEGIN
	SELECT @stat_time = @total_time * int_value / 100
	FROM dbo.Parameters
	WHERE parameter = 'StatMaintenanceWindowPercent' --время, отведённое на обслуживание статистки. Параметр хранится в процентах от общего времени. / Statistics maintenance time. Stored as percents of total maintenance time
END
ELSE IF @stat_time is null and @null_flag = 1
	SET @stat_time = 0
ELSE
	SET @stat_time = @total_time * @stat_time / 100


--Print 'Stat time'
--Print @stat_time

IF @stat_time+@index_time+@check_time>@total_time
	BEGIN
	RAISERROR('Error during parameters check. Sum of index_time, check_time and stat_time cannot be more than total time!',16,1)
	RETURN
	END




SELECT @log_space_threshold_mb = int_value
FROM dbo.Parameters 
WHERE parameter = 'TranLogSpaceThresholdMb'

--Формирование списка обслуживаемых БД \ Creating a list of DB being optimized

DECLARE @db_list TABLE
(
	database_id int
)

INSERT @db_list
SELECT database_id 
FROM dbo.GetDbList(@use_system_db, @use_user_db, @dbname_list, @except_list) t



DECLARE @operation_types TABLE (
	subsystem_id int,
	action_type_id int,
	finish_time datetime --Время, до которого можно исполнять задания такого типа
)

DECLARE @start_time datetime = getdate()

INSERT INTO @operation_types SELECT 1,1,DATEADD(s, @index_time, @start_time) WHERE @indexes = 1 AND @online_only = 0
INSERT INTO @operation_types SELECT 1,2,DATEADD(s, @index_time, @start_time) WHERE @indexes = 1
INSERT INTO @operation_types SELECT 1,3,DATEADD(s, @index_time, @start_time) WHERE @indexes = 1

INSERT INTO @operation_types SELECT 2,1,DATEADD(s, @index_time+@stat_time, @start_time) WHERE @stats = 1

INSERT INTO @operation_types SELECT 3,1,DATEADD(s, @index_time+@stat_time+@check_time, @start_time) WHERE @checkall = 1 OR @checkcatalog = 1
INSERT INTO @operation_types SELECT 3,2,DATEADD(s, @index_time+@stat_time+@check_time, @start_time) WHERE @checkall = 1 OR @checkalloc = 1
INSERT INTO @operation_types SELECT 3,3,DATEADD(s, @index_time+@stat_time+@check_time, @start_time) WHERE @checkall = 1 OR @checktable = 1


SET @afterparty = ~CAST(@afterparty  as bit)  --Инвертируем afterparty. 0 - два прогона цикла, т.е. обычный+afterparty, 1 - один прогон цикла без afterparty.

 --При первой итерации этого цикла происходит обычная обработка,
 --а при второй - !!AFTERPARTY!! (dancing smile) (drunken smile)
 --First iteration is normal mode, second - afterparty

WHILE @afterparty < 2 
BEGIN

	SET @subsystem_id = 1

	--Цикл по подсистемам. Нужен чтобы между индексами и статистикой обновить задачи на статистику
	WHILE @subsystem_id < 4
	BEGIN

		--Очередь заданий по сбору статистики следует формировать сразу после перестройки индексов, т.к. часть статистик будет уже обновлена, а часть ещё нет.  
		--Statistics maintenance tasks should be added right before execution, because some of statistics will be updated during index maintenance.
		IF @subsystem_id = 2 and @add_stats_runtime = 1 and @stats = 1
		BEGIN

			DECLARE DB CURSOR
			FOR SELECT database_id from @db_list
				
			OPEN DB

			FETCH NEXT FROM DB INTO @db

			WHILE @@FETCH_STATUS = 0
			BEGIN
				EXEC [dbo].[FillQueueStat] @db
				FETCH NEXT FROM DB INTO @db
			END

			CLOSE DB
			
			DEALLOCATE DB
		
		END

		--This cursor iterates over tasks
		DECLARE command CURSOR
		FOR
		SELECT 
			t1.entry_id
			,t1.[database_id]
			,t1.command
			,t1.subsystem_id
			,t1.action_type_id
			,t1.size_mb
			,t1.table_id
			,t1.index_id
			,t1.partition_n
			,t2.finish_time
		FROM 
			dbo.Tasks t1
			INNER JOIN @operation_types t2 ON t1.subsystem_id = t2.subsystem_id AND t1.action_type_id = t2.action_type_id
		WHERE 1=1 
			AND t1.subsystem_id = @subsystem_id
			AND date_started IS NULL
			AND date_completed IS NULL --невыполненные задания заданного типа / Not completed tasks of each type
			AND [database_id] in (select database_id from @db_list) --Только указанные БД / Selected DBs only
		ORDER BY 
			CASE 
				WHEN @subsystem_id = 3 THEN t1.action_type_id
				ELSE NULL
			END
			,t1.[priority] --Этот столбец определяет, в каком порядке выполнять таски внутри группы.
			, CASE --для каждой подсистемы свой порядок сортировки заданий / Each subsystem_id uses it's own tasks sorting
				WHEN @subsystem_id = 1
					THEN entry_id
				END --просто по порядку, задания в очереди в порядке убывания критичности. / by entry_id. Tasks have been sorted while insertion.
			,CASE 
				WHEN @subsystem_id = 2
					THEN rowmod_factor
				END DESC -- в порядке убывания значения превышения порога перерасчёта статистики. rowmod_factor - это на сколько процентов превышен порог. / By rowmod_factor. It's a percent of dynamic threshold violation.
			,CASE 
				WHEN @subsystem_id = 3
					THEN checked_daysago
				END DESC --В порядке убывания количества дней с момента последней проверки / In descending order of days since last integrity check.
			,CASE 
				WHEN @subsystem_id = 3
					AND checked_daysago IS NULL
					THEN size_mb --если проверки не проводилось, то начинаем с самых маленьких / If tables has not been checked at all, then start with the smallest.
				END

		OPEN command

		FETCH NEXT
		FROM command
		INTO @entry_id
			,@db
			,@command
			,@subsystem_id
			,@action_type_id
			,@size_mb
			,@table_id
			,@index_id
			,@partition_number
			,@finish_time


		WHILE @@FETCH_STATUS = 0
		BEGIN

			IF NOT EXISTS (SELECT 1 FROM dbo.Workers WHERE worker_name = @worker_name and stoplight = 0)
			BEGIN
				SET @stoplight = 1
				BREAK
			END

			IF EXISTS (select 1 from dbo.Tasks (nolock) where entry_id = @entry_id and (worker_name is NULL or worker_name = @worker_name)) --Task is not started by another worker
			BEGIN
		
				IF @subsystem_id  = 1 --Index operations may require some logspace.
					BEGIN
					EXEC @log_space = dbo.CheckLogSpaceLeft @db, @log_space_threshold_mb 
					IF @check_backup_state = 1
						BEGIN
						SELECT @db_backup = dbo.GetDBBackupState(@db) --check if backup is running for current database
						END
						ELSE SET @db_backup = 0	
					IF (@@MicrosoftVersion/0x01000000)>=11 and @check_ag_state = 1
						BEGIN 
						SELECT @ag_state = dbo.GetAGSyncState(@db,@ag_max_queue)
						END
					ELSE SET @ag_state = 0
					END
				ELSE 
					BEGIN
					SET @log_space = 1 --Stats operations does not generate so many log records
					SET @db_backup = 0
					SET @ag_state = 0
					END
				SET @t1 = getdate() --засекаем время начала шага / Save the task beginning time

				-- рассчитываем сколько времени может потребоваться для выполнения данного шага
				-- на основе сведений о продолжительности прошлых выполнений аналогичной операции над тем же объектом
				-- Predicting how much time step can take basing on similar tasks execution time (same subsystem, same action type and same object).
				SELECT @timefactor = ISNULL(dbo.GetTimeFactor(@db,1,@table_id,@index_id,@partition_number,@subsystem_id, @action_type_id,60,1),0) 

				IF	DATEADD(s, (@size_mb * @timefactor), @t1) < @finish_time 
					AND @log_space = 1 and @db_backup = 0 and @ag_state = 0--если остатка времени и места под логи предположительно хватит на выполнение команды и бэкап не помешает. / Check if we have enough time and log space to execute the task adn the database backup will not interfere
				BEGIN
	
					UPDATE dbo.Tasks
					SET 
						date_started = getdate()
						,worker_name = @worker_name
						,[execution_id] = @exec_guid
					WHERE 
						entry_id = @entry_id

					SET @msg = 'Ok' --Если не произойдёт ошибки, то результатом выполнения операции будет Ok. / Setting Ok as a default exit message.
					SET @deadlock_flag = 0
					SET @exit_code = 1

					BEGIN TRY
						UPDATE dbo.[WorkerSessions]
						SET 
							subsystem_id = @subsystem_id, 
							entry_id = @entry_id
						WHERE 
							worker_name = @worker_name
						--PRINT @command
						EXEC (@command)
					END TRY

					BEGIN CATCH

						SET @exit_code = ERROR_NUMBER()
				
						IF ERROR_NUMBER() in (1205,1222,1912)
							SET @deadlock_flag = 1
				
						SET @msg = N'Error code: ' + CAST(ERROR_NUMBER() AS NVARCHAR(10)) + N'. Error message:' + ERROR_MESSAGE()

						PRINT 'Error execuring "'+@command+'"   '+@msg

						SET @error_count += 1 --Global flag indicating that there were at least one error

					END CATCH

					--IF @msg = 'Ok'
					--BEGIN
					--SET @msg = 'Ok' + '. Time prognose was: '+CAST((@size_mb * @timefactor) as NVARCHAR(50)) + ' sec.'
					--END

					UPDATE dbo.Tasks
					SET 
						date_completed = GETDATE()
						,duration_s = DATEDIFF(ss, date_started, GETDATE())
						,time_factor = CASE WHEN @exit_code = 1 THEN (DATEDIFF(ms, date_started, GETDATE()) / 1000.0 / (size_mb + 1.0)) ELSE NULL END
						,result = @msg
						,exit_code = @exit_code
					WHERE 
						entry_id = @entry_id
	
					SELECT @stoplight = stoplight FROM dbo.Workers WHERE worker_name = @worker_name
		
				END 
				ELSE
				BEGIN

					IF @log_space = 0 --If not enougth log space
						UPDATE dbo.Tasks
						SET 
							worker_name = @worker_name
							,[execution_id] = @exec_guid
							,date_started = GETDATE()
							,date_completed = GETDATE()
							,duration_s = 0
							,result = 'Skipped. Not enough transaction log space'
							,exit_code = -2
						WHERE 
							entry_id = @entry_id

					IF @db_backup = 1--If backup is running and we need to stop due to that
						UPDATE dbo.Tasks
						SET 
							worker_name = @worker_name
							,[execution_id] = @exec_guid
							,date_started = GETDATE()
							,date_completed = GETDATE()
							,duration_s = 0
							,result = 'Skipped. Database Backup is running and this worker is configured to skip in this case'
							,exit_code = -2
						WHERE 
							entry_id = @entry_id
					IF @ag_state =1--If AG is not healthy or can't keep up with the pace
						UPDATE dbo.Tasks
						SET 
							worker_name = @worker_name
							,[execution_id] = @exec_guid
							,date_started = GETDATE()
							,date_completed = GETDATE()
							,duration_s = 0
							,result = 'Skipped. One of the AG replicas cant keep up with the log growth or is unhealthy'
							,exit_code = -2
						WHERE 
							entry_id = @entry_id
					

					IF DATEADD(SECOND, (@size_mb * @timefactor ), @t1) > @finish_time  --Недостаточно времени 
						AND @afterparty = 1                                             --Мы уже на второй итерации (на первой мы просто пропускаем таск)
						UPDATE dbo.Tasks
						SET 
							worker_name = @worker_name
							,[execution_id] = @exec_guid
							,date_started = GETDATE()
							,date_completed = GETDATE()
							,duration_s = 0
							,result = 'Skipped. Not enough time left'
							,exit_code = -1
						WHERE 
							entry_id = @entry_id
				END
		
			END --If task started by another worker
			-- We simply skip those tasks, because other worker "owns" them 

		
			FETCH NEXT
			FROM command
			INTO @entry_id
				,@db
				,@command
				,@subsystem_id
				,@action_type_id
				,@size_mb
				,@table_id
				,@index_id
				,@partition_number
				,@finish_time
		END

		CLOSE command

		DEALLOCATE command

		IF @stoplight = 1
			BREAK

		SET @subsystem_id += 1
	END
	
	IF @stoplight = 1
		BREAK

	IF @afterparty = 0
	BEGIN
		--Мы прогнали основной цикл один раз, потратив на каждую из стадий отведенное время
		--При этом, возможно мы пропустили некоторые шаги т.к. кончилось время соответствующей стадии
		--Теперь мы можем повторить все еще раз и все-таки выполнить их

		--Снимаем постадийное ограничение
		UPDATE @operation_types
		SET	finish_time = (SELECT max(finish_time) FROM @operation_types)
	
	END

	SET @afterparty = @afterparty + 1 --После второго захода надо завязывать, иначе потом будет болеть голова

END


--Праздник закончился, пора наводить порядок.
--В норме к этому моменту не должно остаться ни одного необработанного таска, кроме как в случае когда мы принудительно остановили воркер
--Тем не менее, здесь мы проверяем, не осталось ли таких тасков и прописываем в них коды ошибок.

--Afterparty is over. It's time to clean up.
--Normally, there should be no unprocessed tasks at this point, only exclusion is if the worker was stopped via stoplight.
--Here we set errorcode to all unprocessed tasks to simplify troubleshoting

UPDATE t1
SET 
	worker_name = @worker_name
	,[execution_id] = @exec_guid
	,date_started = GETDATE()
	,date_completed = GETDATE()
	,duration_s = 0
	,result = CASE WHEN @stoplight = 0 THEN 'Skipped. Reason is unknown' ELSE 'Skipped. User requested to stop' END
	,exit_code = CASE WHEN @stoplight = 0 THEN -4 ELSE -3 END -- There should be no -4 at all! -4 means some bug!
FROM 
	dbo.Tasks t1
	INNER JOIN @operation_types t2 ON t1.subsystem_id = t2.subsystem_id AND t1.action_type_id = t2.action_type_id
WHERE 
	date_completed is null
	and [database_id] in (select database_id from @db_list)
	and worker_name is null

IF @stoplight = 1
BEGIN
	UPDATE dbo.Workers
	SET stoplight = 0
	WHERE worker_name = @worker_name
	AND stoplight <> 0
END

--Calculate the expected execution time (for consistency only due to some stats tasks where generated runtime)

DECLARE TASKS CURSOR
FOR SELECT entry_id, [database_id], table_id,index_id,partition_n,subsystem_id, action_type_id
FROM dbo.Tasks WHERE time_prognosis_s is null


OPEN TASKS

FETCH NEXT FROM TASKS
INTO @entry_id,@db,@table_id,@index_id,@partition_number,@subsystem_id,@action_type_id

WHILE @@FETCH_STATUS = 0 
BEGIN 

UPDATE dbo.Tasks
SET time_prognosis_s = ISNULL(dbo.GetTimeFactor(@db,1,@table_id,@index_id,@partition_number,@subsystem_id, @action_type_id,60,1),0) * size_mb
WHERE entry_id = @entry_id
FETCH NEXT FROM TASKS
INTO @entry_id,@db,@table_id,@index_id,@partition_number,@subsystem_id,@action_type_id

END

CLOSE TASKS
DEALLOCATE TASKS




DELETE FROM dbo.[WorkerSessions]
WHERE worker_name = @worker_name

RETURN @error_count]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[float]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[result]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_started]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_added]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stoplight]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[program_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[program_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@index_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@stat_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@check_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@total_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[int_value]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Parameters].[parameter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@use_system_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@use_user_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@dbname_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@except_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDbList]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDbList].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@indexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@online_only]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@stats]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@checkall]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@checkcatalog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@checkalloc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@checktable]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@afterparty]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@add_stats_runtime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@db_list].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FillQueueStat]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@operation_types].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@operation_types].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[command]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@operation_types].[finish_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_started]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[date_completed]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@db_list].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[priority]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[rowmod_factor]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[checked_daysago]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stoplight]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[CheckLogSpaceLeft]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@check_backup_state]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDBBackupState]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@check_ag_state]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetAGSyncState]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@ag_max_queue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[execution_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@exec_guid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[entry_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[duration_s]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[time_factor]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[size_mb]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[exit_code]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@operation_types].[finish_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@operation_types].[finish_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[time_prognosis_s]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetTimeFactor]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[ProcessQueueAll].[@db_list]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ProcessQueueAll].[@db_list].[database_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[ProcessQueueAll].[@operation_types]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ProcessQueueAll].[@operation_types].[subsystem_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ProcessQueueAll].[@operation_types].[action_type_id]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[int]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlSimpleColumn" Name="[dbo].[ProcessQueueAll].[@operation_types].[finish_time]">
									<Relationship Name="TypeSpecifier">
										<Entry>
											<Element Type="SqlTypeSpecifier">
												<Relationship Name="Type">
													<Entry>
														<References ExternalSource="BuiltIns" Name="[datetime]" />
													</Entry>
												</Relationship>
											</Element>
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@use_user_db]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@use_system_db]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@dbname_list]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA['']]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@except_list]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@indexes]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@stats]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@checkall]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@checktable]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@checkalloc]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@checkcatalog]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@online_only]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@check_backup_state]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@check_ag_state]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@ag_max_queue]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@afterparty]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@add_stats_runtime]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[1]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@worker_name]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@total_time]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@index_time]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@check_time]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@stat_time]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[ProcessQueueAll].[@exec_guid]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="1960" />
				<Property Name="Length" Value="20378" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;&#xD;&#xA;Процедура обработки очереди заданий в таблице dbo.Tasks.&#xD;&#xA;Задания делятся по подсистемам (subsystem) и типам операций (action_type). Описание в таблице dbo.OperationTypes.&#xD;&#xA;Задания обрабатываются в следующем порядке подсистем: &#xD;&#xA;1. Обслуживание индексов&#xD;&#xA;2. Обслуживание статистики с предварительным формированием заданий, дабы не обновлять статистику, обновлённую при перестройке индексов.&#xD;&#xA;3. Проверка целостности.&#xD;&#xA;Порядок подсистем неизменен, т.к. представляется единственно разумным.&#xD;&#xA;Внутри каждой подсистемы задания упорядочиваются отдельным образом.&#xD;&#xA;Ведётся учёт остатка времени и предсказание продолжительности операций за счёт статистики прошлых выполнений за месяц по тем же объектам.&#xD;&#xA;Общий лимит времени делится в процентах между подсистемами. Настройки в таблице dbo.Parameters.&#xD;&#xA;После каждой операции выполняется запись показателей времени и результата для дальнейшего использования в прогнозах времени выполнения аналогичных операций.&#xD;&#xA;&#xD;&#xA;English:&#xD;&#xA;&#xD;&#xA;Stored procedure processes the queue of tasks form dbo.Tasks table.&#xD;&#xA;Tasks are devided by subsystems and action types.&#xD;&#xA;Tasks are processed in specific order:&#xD;&#xA;1. Index maintenance&#xD;&#xA;2. Satistics update (tasks formed prior to execution to exclude stats updated during index rebuild on step 1)&#xD;&#xA;3. Table integrity checks&#xD;&#xA;&#xD;&#xA;In each subsystem_id taks are ordered different.&#xD;&#xA;Time is tracked and each operation time consumption is predicted by calculating previous execution times and extropolating it on current size of object.&#xD;&#xA;Total maintenance time is devided between subsystems in percents. See dbo.Parameters.&#xD;&#xA;After each task its duration is saved for future use.&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[ProcessQueueAll] &#xD;&#xA;&#x9;@use_user_db int =1 --process tasks for all online user DB's&#xD;&#xA;&#x9;,@use_system_db int = 0 --process tasks for all system DB's&#xD;&#xA;&#x9;,@dbname_list nvarchar(500) = '' --list of DB's.&#xD;&#xA;&#x9;,@except_list bit = 0 --DB selection inversion&#xD;&#xA;&#x9;,@indexes bit = 1&#xD;&#xA;&#x9;,@stats bit = 1&#xD;&#xA;&#x9;,@checkall bit = 1&#xD;&#xA;&#x9;,@checktable bit = 1&#xD;&#xA;&#x9;,@checkalloc bit = 1&#xD;&#xA;&#x9;,@checkcatalog bit = 1&#xD;&#xA;&#x9;,@online_only bit = 1 --perform online operations only&#xD;&#xA;&#x9;,@check_backup_state bit = 1&#xD;&#xA;&#x9;,@check_ag_state bit = 1&#xD;&#xA;&#x9;,@ag_max_queue bigint&#xD;&#xA;&#x9;,@afterparty int = 1 --redistribute remaining time in the end. Ex: We spend not all the time during stats update and this time can be used for rebuilding indexes after all operations pass.&#xD;&#xA;&#x9;,@add_stats_runtime bit = 1 --It's better to add update statistics tasks after index maintenance, but you may deactivate this feature by passing 0 here.&#xD;&#xA;&#x9;,@worker_name nvarchar(255)&#xD;&#xA;&#x9;,@total_time BIGINT&#xD;&#xA;&#x9;,@index_time BIGINT&#xD;&#xA;&#x9;,@check_time BIGINT&#xD;&#xA;&#x9;,@stat_time BIGINT&#xD;&#xA;&#x9;,@exec_guid uniqueidentifier&#xD;&#xA;&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[dbo].[StartWorker]">
			<Property Name="BodyScript">
				<Value><![CDATA[
SET NOCOUNT ON
DECLARE 
	@use_user_db1 bit
	,@use_system_db1 bit
	,@dbname_list1 nvarchar(500)
	,@except_list1 bit
	,@indexes1 bit
	,@stats1 bit 
	,@checkall1 bit
	,@checktable1 bit
	,@checkalloc1 bit
	,@checkcatalog1 bit
	,@online_only1 bit
	,@check_backup_state1 bit
	,@check_ag_state1 bit
	,@ag_max_queue1 bigint
	,@afterparty1 bit
	,@add_stats_runtime1 bit
	,@totaltimemin1 bigint
	,@indextime1 bigint
	,@stattime1 bigint
	,@checktime1 bigint

IF @exec_guid is null
	SET @exec_guid = NEWID()

IF NOT EXISTS (SELECT 1 FROM dbo.Workers where worker_name = @worker_name)
	BEGIN
	RAISERROR('No such worker registered! Please note the case of letters.',16,1)
	RETURN
	END
ELSE
BEGIN
SELECT 
	@use_user_db1 = [use_user_db]
	,@use_system_db1 =[use_system_db]
	,@dbname_list1 = [dbname_list]
	,@except_list1 =[except_list]
	,@indexes1 = [indexes]
	,@stats1 = [stats]
	,@checkall1 = [checkall]
	,@checktable1 = [checktable]
	,@checkalloc1 = [checkalloc]
	,@checkcatalog1 =[checkcatalog]
	,@online_only1 = [online_only]
	,@check_backup_state1 = [check_backup_state]
	,@check_ag_state1 =[check_ag_state]
	,@ag_max_queue1 = [ag_max_queue]
	,@afterparty1 = [afterparty]
	,@add_stats_runtime1 = [add_stats_runtime]
	,@totaltimemin1 = [totaltimemin]
	,@indextime1 = [indextime]
	,@stattime1 = [stattime]
	,@checktime1 = [checktime]
FROM 
	dbo.Workers
where 
	[worker_name] = @worker_name


--Clean WorkerSession. Just in case....	  
DELETE FROM dbo.[WorkerSessions]
WHERE not exists(
	select 1 from sys.dm_exec_sessions es 
		where es.session_id = dbo.[WorkerSessions].session_id 
		and es.program_name COLLATE DATABASE_DEFAULT = dbo.[WorkerSessions].program_name COLLATE DATABASE_DEFAULT
		and es.status in ('running','runnable','suspended'))


EXEC dbo.ProcessQueueAll
	@use_user_db = @use_user_db1
	,@use_system_db =@use_system_db1
	,@dbname_list = @dbname_list1
	,@except_list =@except_list1
	,@indexes = @indexes1
	,@stats = @stats1 
	,@checkall = @checkall1
	,@checktable = @checktable1
	,@checkalloc = @checkalloc1
	,@checkcatalog =@checkcatalog1
	,@online_only = @online_only1
	,@check_backup_state = @check_backup_state1
	,@check_ag_state = @check_ag_state1
	,@ag_max_queue = @ag_max_queue1
	,@afterparty = @afterparty1
	,@add_stats_runtime = @add_stats_runtime1
	,@worker_name = @worker_name
	,@total_time = @totaltimemin1
	,@index_time = @indextime1
	,@stat_time = @stattime1
	,@check_time = @checktime1
,@exec_guid = @exec_guid

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bit]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[bigint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[StartWorker].[@exec_guid]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[StartWorker].[@worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[use_user_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[use_system_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[dbname_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[except_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[indexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stats]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkall]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checktable]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkalloc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checkcatalog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[online_only]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[check_backup_state]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[check_ag_state]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[ag_max_queue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[afterparty]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[add_stats_runtime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[totaltimemin]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[indextime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[stattime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[checktime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Workers].[worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[session_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[session_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[program_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[WorkerSessions].[program_name]" />
				</Entry>
				<Entry>
					<References ExternalSource="master.dacpac" Name="[master]|[sys].[dm_exec_sessions].[status]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@use_user_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@use_system_db]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@dbname_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@except_list]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@indexes]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@stats]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@checkall]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@checktable]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@checkalloc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@checkcatalog]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@online_only]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@check_backup_state]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@check_ag_state]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@ag_max_queue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@afterparty]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@add_stats_runtime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@worker_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@total_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@index_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@stat_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@check_time]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[ProcessQueueAll].[@exec_guid]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[StartWorker].[@worker_name]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[StartWorker].[@exec_guid]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[null]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="868" />
				<Property Name="Length" Value="3504" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="/*&#xD;&#xA;-- THIS SAMPLE CODE AND ANY RELATED INFORMATION ARE PROVIDED &quot;AS IS&quot; WITHOUT&#xD;&#xA;--WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT&#xD;&#xA;--LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS&#xD;&#xA;--FOR A PARTICULAR PURPOSE.&#xD;&#xA;&#xD;&#xA;Author: Oleg Trutnev otrutnev@microsoft.com&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;Russian:&#xD;&#xA;Хранимая процедура запуска заданий обслуживания с заранее сохраненным набором параметров. &#xD;&#xA;Сначала необходимо заполнить профиль в таблице Workers. Все поля обязательны, кроме date_added.&#xD;&#xA;После сохранения профиля значение worker_name может быть использовано для запука задания с этими параметрами.&#xD;&#xA;&#xD;&#xA;English:&#xD;&#xA;Procedure starts maintenance tasks execution from queue with parameters, saved to dbo.Workers table.&#xD;&#xA;All the fields there should be filled except date_added.&#xD;&#xA;Then the worker_name can be used to start workers with this parameters.&#xD;&#xA;&#xD;&#xA;*/&#xD;&#xA;&#xD;&#xA;CREATE PROCEDURE [dbo].[StartWorker] &#xD;&#xA;&#x9;@worker_name nvarchar(255),&#xD;&#xA;&#x9;@exec_guid uniqueidentifier = null&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Tasks]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[entry_id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[batch_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[subsystem_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[action_type_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[command]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="4000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[date_added]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[date_started]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[date_completed]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[duration_s]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[database_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[table_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[index_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[partition_n]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[maxdop]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[user_scans]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[user_seeks]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[user_updates]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[rowcnt]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[size_mb]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="3" />
									<Property Name="Precision" Value="38" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[ix_frag]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="3" />
									<Property Name="Precision" Value="10" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[time_factor]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Precision" Value="53" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[float]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[rowmod_factor]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Precision" Value="53" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[float]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[checked_daysago]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[result]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[time_prognosis_s]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[exit_code]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[worker_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[execution_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[uniqueidentifier]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[priority]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Tasks].[volume_mount_point]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="48" />
			<AttachedAnnotation Disambiguator="44" />
		</Element>
		<Element Type="SqlIndex" Name="[dbo].[Tasks].[NC_db_subs_dc]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[database_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[subsystem_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[date_completed]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="IndexedObject">
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlIndex" Name="[dbo].[Tasks].[NC_db_tbl_ix_prt]">
			<Property Name="FillFactor" Value="50" />
			<Property Name="IsPadded" Value="True" />
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[database_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[table_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[index_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[partition_n]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[date_completed]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[subsystem_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[action_type_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[time_factor]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[exit_code]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="IncludedColumns">
				<Entry>
					<References Name="[dbo].[Tasks].[duration_s]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[ix_frag]" />
				</Entry>
			</Relationship>
			<Relationship Name="IndexedObject">
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlIndex" Name="[dbo].[Tasks].[NC_IX_duration_plus_five]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Tasks].[time_prognosis_s]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="IncludedColumns">
				<Entry>
					<References Name="[dbo].[Tasks].[entry_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[subsystem_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[action_type_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[database_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[table_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[index_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Tasks].[partition_n]" />
				</Entry>
			</Relationship>
			<Relationship Name="IndexedObject">
				<Entry>
					<References Name="[dbo].[Tasks]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Workers]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[worker_name]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[date_added]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="43" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[owner]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="150" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="15" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[comment]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="16" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[use_user_db]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="17" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[use_system_db]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="18" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[dbname_list]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="19" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[except_list]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="20" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[indexes]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="21" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[frag_eval_time_limit_s]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[stats]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="22" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[stats_sample]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="23" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[checkall]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="24" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[checktable]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="25" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[checkalloc]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="26" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[checkcatalog]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="27" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[online_only]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="28" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[check_backup_state]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="29" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[check_ag_state]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="30" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[ag_max_queue]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="31" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[afterparty]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="32" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[add_stats_runtime]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="33" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[totaltimemin]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[indextime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[stattime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[checktime]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[latched_spid]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="34" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Workers].[stoplight]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="35" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="49" />
			<AttachedAnnotation Disambiguator="42" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[WorkerSessions]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[WorkerSessions].[record_date]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="36" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[WorkerSessions].[worker_name]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[WorkerSessions].[session_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[WorkerSessions].[program_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="150" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[WorkerSessions].[subsystem_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[WorkerSessions].[entry_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[WorkerSessions].[is_afterparty]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="37" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Filegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="45" />
			<AttachedAnnotation Disambiguator="41" />
		</Element>
	</Model>
</DataSchemaModel>